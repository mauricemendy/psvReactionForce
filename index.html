<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PSV Reaction Force Calculator</title>

  <!-- External Libraries via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Design System - CSS Variables (Maurice Design System) */
    :root {
      /* Primary Colors - Teal */
      --color-primary: #0D9488;
      --color-primary-dark: #0F766E;
      --color-primary-darker: #115E59;
      --color-primary-light: #F0FDFA;
      --color-primary-lighter: #CCFBF1;

      /* Accent - Black for primary buttons */
      --color-accent: #111827;
      --color-accent-dark: #1F2937;
      --color-accent-darker: #374151;

      /* Semantic Colors */
      --color-success: #0D9488;
      --color-success-light: #F0FDFA;
      --color-warning: #D97706;
      --color-warning-light: #FEF3C7;
      --color-error: #DC2626;
      --color-error-light: #FEE2E2;
      --color-info: #6B7280;

      /* Neutrals */
      --color-gray-50: #F9FAFB;
      --color-gray-100: #F3F4F6;
      --color-gray-200: #E5E7EB;
      --color-gray-300: #D1D5DB;
      --color-gray-400: #9CA3AF;
      --color-gray-500: #6B7280;
      --color-gray-600: #4B5563;
      --color-gray-700: #374151;
      --color-gray-800: #1F2937;
      --color-gray-900: #111827;

      /* Backgrounds */
      --bg-page: #F3F4F6;
      --bg-surface: #FFFFFF;

      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;

      /* Typography */
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', 'Consolas', monospace;

      /* Shadows - Subtle */
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.05), 0 2px 4px rgba(0,0,0,0.03);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.05), 0 4px 6px rgba(0,0,0,0.03);

      /* Focus Rings */
      --ring-primary: 0 0 0 3px rgba(13, 148, 136, 0.15);
      --ring-error: 0 0 0 3px rgba(220, 38, 38, 0.15);

      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
      --radius-full: 9999px;

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg-page);
      color: var(--color-gray-900);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-6) var(--space-4);
    }

    @media (min-width: 768px) {
      .container {
        padding: var(--space-8) var(--space-6);
      }
    }

    @media (min-width: 1024px) {
      .container {
        padding: var(--space-10) var(--space-8);
      }

      .container.batch-mode {
        max-width: 1400px;
      }
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: var(--space-6);
      padding: var(--space-6) var(--space-4);
      background: var(--bg-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
    }

    .header h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--color-gray-900);
      margin-bottom: var(--space-2);
      line-height: 1.25;
    }

    .header p {
      font-size: 16px;
      color: var(--color-gray-500);
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Mode Switcher */
    .mode-switcher {
      display: flex;
      justify-content: center;
      gap: var(--space-2);
      margin-bottom: var(--space-6);
      padding: var(--space-1);
      background: var(--color-gray-100);
      border-radius: var(--radius-md);
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
    }

    .mode-btn {
      padding: var(--space-3) var(--space-6);
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      color: var(--color-gray-700);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: var(--font-sans);
    }

    .mode-btn:hover {
      color: var(--color-gray-900);
    }

    .mode-btn.active {
      background: var(--bg-surface);
      color: var(--color-primary);
      box-shadow: var(--shadow-sm);
    }

    /* Main Layout - Desktop 2 columns */
    .calc-layout {
      display: block;
      margin-bottom: var(--space-8);
    }

    @media (min-width: 1024px) {
      .calc-layout {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: var(--space-6);
        align-items: start;
      }
    }

    /* Input Section */
    .input-section {
      margin-bottom: var(--space-6);
    }

    @media (min-width: 1024px) {
      .input-section {
        margin-bottom: 0;
        position: sticky;
        top: var(--space-4);
        max-height: calc(100vh - var(--space-8));
        overflow-y: auto;
      }
    }

    /* Parameter Card */
    .param-card {
      background: var(--bg-surface);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-4);
    }

    .param-card h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-gray-100);
    }

    .param-group {
      margin-bottom: var(--space-4);
    }

    .param-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-gray-700);
      margin-bottom: 6px;
    }

    .required {
      color: var(--color-error);
      margin-left: 2px;
    }

    /* Input with Unit */
    .input-with-unit {
      display: flex;
      gap: var(--space-2);
    }

    .input-with-unit input {
      flex: 1;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    select, input[type="number"], input[type="text"] {
      width: 100%;
      height: 40px;
      padding: 10px 12px;
      border: 1px solid var(--color-gray-300);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-family: var(--font-sans);
      color: var(--color-gray-900);
      background: var(--bg-surface);
      transition: all var(--transition-base);
    }

    select:focus, input[type="number"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--ring-primary);
    }

    .unit-select {
      width: 100px;
      background: var(--color-gray-50);
      font-size: 13px;
      color: var(--color-gray-700);
    }

    .helper-text {
      display: block;
      font-size: 12px;
      color: var(--color-gray-500);
      margin-top: 4px;
    }

    /* Formula Box */
    .formula-box {
      background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
      border-left: 4px solid var(--color-info);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-top: var(--space-6);
    }

    .formula-box h5 {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-2);
    }

    .formula {
      font-family: 'Courier New', monospace;
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-3);
    }

    .formula-legend {
      font-size: 12px;
      color: var(--color-gray-700);
      line-height: 1.6;
    }

    /* Action Group */
    .action-group {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-6);
      flex-wrap: wrap;
    }

    /* Buttons */
    .btn {
      padding: 12px 20px;
      border-radius: var(--radius-lg);
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font-sans);
      border: none;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      justify-content: center;
      min-height: 44px;
    }

    .btn-primary {
      background: var(--color-accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-accent-dark);
    }

    .btn-primary:active {
      background: var(--color-accent-darker);
    }

    .btn-primary:disabled {
      background: var(--color-gray-300);
      color: var(--color-gray-400);
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-surface);
      color: var(--color-gray-700);
      border: 1px solid var(--color-gray-300);
    }

    .btn-secondary:hover {
      background: var(--color-gray-50);
    }

    .btn-secondary:active {
      background: var(--color-gray-100);
    }

    .btn-success {
      background: var(--color-success);
      color: white;
    }

    .btn-success:hover {
      background: var(--color-primary-dark);
    }

    .btn-large {
      height: 48px;
      padding: 12px 24px;
      font-size: 15px;
    }

    .btn-icon {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 13px;
      min-height: 36px;
    }

    .btn-danger {
      background: transparent;
      color: var(--color-error);
      border: 1px solid var(--color-error);
    }

    .btn-danger:hover {
      background: var(--color-error-light);
    }

    /* Results Section */
    .results-section {
      display: none;
    }

    .results-section.show {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-card {
      background: var(--bg-surface);
      border-left: 4px solid var(--color-success);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-4);
    }

    .result-card h3 {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-gray-100);
    }

    .result-item {
      padding: var(--space-4) 0;
      border-bottom: 1px solid var(--color-gray-100);
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-label {
      display: block;
      font-size: 14px;
      color: var(--color-gray-700);
      margin-bottom: var(--space-2);
    }

    .result-value-group {
      display: flex;
      align-items: baseline;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
    }

    .result-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--color-gray-900);
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }

    .result-unit {
      font-size: 16px;
      color: var(--color-gray-500);
    }

    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .badge-success {
      background: var(--color-success);
      color: white;
    }

    .badge-error {
      background: var(--color-error-light);
      color: var(--color-error);
    }

    .badge-info {
      background: var(--color-gray-100);
      color: var(--color-gray-700);
    }

    .badge-warning {
      background: var(--color-warning-light);
      color: var(--color-warning);
    }

    /* Reference Tables */
    .reference-section {
      margin-top: var(--space-10);
    }

    .reference-section h3 {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-6);
    }

    .table-container {
      background: var(--bg-surface);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-6);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--color-gray-50);
    }

    th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      font-size: 10px;
      font-weight: 600;
      color: var(--color-gray-400);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--color-gray-200);
      font-size: 14px;
      color: var(--color-gray-900);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: var(--color-gray-50);
    }

    /* ======================= */
    /* BATCH MODE STYLES       */
    /* ======================= */

    .batch-section {
      display: none;
    }

    .batch-section.show {
      display: block;
    }

    .simple-section {
      display: block;
    }

    .simple-section.hide {
      display: none;
    }

    /* Batch Input Method Selector */
    .input-method-selector {
      display: flex;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .input-method-option {
      flex: 1;
      padding: var(--space-4);
      border: 2px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: center;
    }

    .input-method-option:hover {
      border-color: var(--color-gray-300);
    }

    .input-method-option.active {
      border-color: var(--color-primary);
      background: rgba(79, 124, 255, 0.05);
    }

    .input-method-option input {
      display: none;
    }

    .input-method-option .method-label {
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-1);
    }

    .input-method-option .method-desc {
      font-size: 12px;
      color: var(--color-gray-500);
    }

    /* Batch Form Container */
    .batch-form-container {
      background: var(--bg-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-6);
    }

    .batch-form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-gray-100);
    }

    .batch-form-header h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-900);
    }

    .batch-form-actions {
      display: flex;
      gap: var(--space-2);
    }

    /* Batch Table */
    .batch-table-wrapper {
      overflow-x: auto;
      margin-bottom: var(--space-4);
    }

    .batch-table {
      width: 100%;
      min-width: 900px;
      border-collapse: collapse;
    }

    .batch-table th {
      background: var(--color-gray-50);
      padding: var(--space-3);
      font-size: 10px;
      font-weight: 600;
      color: var(--color-gray-400);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: center;
      white-space: nowrap;
    }

    .batch-table td {
      padding: var(--space-2);
      border-bottom: 1px solid var(--color-gray-100);
      vertical-align: top;
    }

    .batch-table input,
    .batch-table select {
      height: 36px;
      font-size: 13px;
      padding: 6px 10px;
    }

    .batch-table .input-cell {
      min-width: 120px;
    }

    .batch-table .select-cell {
      min-width: 100px;
    }

    .batch-table .action-cell {
      width: 50px;
      text-align: center;
    }

    .batch-table .row-number {
      width: 40px;
      text-align: center;
      color: var(--color-gray-500);
      font-size: 12px;
      font-weight: 500;
    }

    .batch-table .delete-row-btn {
      background: transparent;
      border: none;
      color: var(--color-gray-400);
      cursor: pointer;
      padding: var(--space-2);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }

    .batch-table .delete-row-btn:hover {
      color: var(--color-error);
      background: #FEE2E2;
    }

    /* Input Validation States */
    .batch-table input.valid,
    .batch-table select.valid {
      border-color: var(--color-success);
    }

    .batch-table input.invalid,
    .batch-table select.invalid {
      border-color: var(--color-error);
      background: #FEF2F2;
    }

    .batch-table input.touched:invalid,
    .batch-table select.touched:invalid {
      border-color: var(--color-error);
    }

    .field-error {
      font-size: 11px;
      color: var(--color-error);
      margin-top: 2px;
    }

    /* CSV Import Zone */
    .csv-import-zone {
      display: none;
    }

    .csv-import-zone.show {
      display: block;
    }

    .drop-zone {
      border: 2px dashed var(--color-gray-300);
      border-radius: var(--radius-xl);
      padding: var(--space-10);
      text-align: center;
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    .drop-zone:hover {
      border-color: var(--color-primary);
      background: rgba(79, 124, 255, 0.02);
    }

    .drop-zone.drag-over {
      border-color: var(--color-primary);
      background: rgba(79, 124, 255, 0.05);
      border-style: solid;
    }

    .drop-zone-icon {
      font-size: 48px;
      margin-bottom: var(--space-4);
    }

    .drop-zone-text {
      font-size: 16px;
      color: var(--color-gray-700);
      margin-bottom: var(--space-2);
    }

    .drop-zone-hint {
      font-size: 13px;
      color: var(--color-gray-500);
    }

    .file-input {
      display: none;
    }

    /* CSV Preview */
    .csv-preview {
      display: none;
      margin-top: var(--space-6);
    }

    .csv-preview.show {
      display: block;
    }

    .csv-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    .csv-preview-stats {
      display: flex;
      gap: var(--space-4);
    }

    .csv-preview-stat {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 14px;
    }

    .csv-errors-list {
      background: #FEF2F2;
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      max-height: 200px;
      overflow-y: auto;
    }

    .csv-error-item {
      font-size: 13px;
      color: var(--color-error);
      padding: var(--space-1) 0;
    }

    /* Batch Results */
    .batch-results {
      display: none;
    }

    .batch-results.show {
      display: block;
    }

    .batch-results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
      gap: var(--space-3);
    }

    .batch-results-stats {
      display: flex;
      gap: var(--space-4);
    }

    .results-table-wrapper {
      overflow-x: auto;
    }

    .results-table {
      width: 100%;
      min-width: 1000px;
      border-collapse: collapse;
    }

    .results-table th {
      background: var(--color-gray-50);
      padding: var(--space-3);
      font-size: 10px;
      font-weight: 600;
      color: var(--color-gray-400);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: center;
      white-space: nowrap;
      position: sticky;
      top: 0;
    }

    .results-table td {
      padding: var(--space-3);
      border-bottom: 1px solid var(--color-gray-200);
      font-size: 13px;
      text-align: center;
    }

    .results-table .text-left {
      text-align: left;
    }

    .results-table .text-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .results-table .force-cell {
      font-size: 16px;
      font-weight: 700;
      color: var(--color-gray-900);
    }

    .results-table tr.row-error {
      background: #FEF2F2;
    }

    .results-table tr.row-error td {
      color: var(--color-gray-500);
    }

    /* Export Actions */
    .export-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
      margin-top: var(--space-4);
      flex-wrap: wrap;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      background: var(--color-gray-900);
      color: white;
      padding: var(--space-4) var(--space-6);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      display: none;
      animation: slideIn 0.3s ease;
    }

    .toast.show {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .toast.success {
      background: var(--color-success);
    }

    .toast.error {
      background: var(--color-error);
    }

    @keyframes slideIn {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: 999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--color-gray-200);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spinner 0.8s linear infinite;
    }

    .loading-text {
      margin-top: var(--space-4);
      font-size: 14px;
      color: var(--color-gray-700);
    }

    /* Session Restore Banner */
    .session-restore-banner {
      display: none;
      background: #FEF3C7;
      border: 1px solid #F59E0B;
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      justify-content: space-between;
      align-items: center;
    }

    .session-restore-banner.show {
      display: flex;
    }

    .session-restore-text {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 14px;
      color: var(--color-gray-900);
    }

    .session-restore-actions {
      display: flex;
      gap: var(--space-2);
    }

    /* Responsive */
    @media (max-width: 640px) {
      .container {
        padding: var(--space-4) var(--space-3);
      }

      .header h1 {
        font-size: 24px;
      }

      .header p {
        font-size: 14px;
      }

      .header {
        margin-bottom: var(--space-4);
      }

      .mode-switcher {
        width: 100%;
      }

      .mode-btn {
        flex: 1;
        padding: var(--space-3) var(--space-2);
        font-size: 13px;
      }

      .action-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      .result-value {
        font-size: 28px;
      }

      .param-card {
        padding: var(--space-4);
      }

      .input-method-selector {
        flex-direction: column;
      }

      .batch-form-container {
        padding: var(--space-4);
      }

      .batch-form-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-3);
      }

      .export-actions {
        flex-direction: column;
      }

      /* Card view for batch results on mobile */
      .batch-results-cards {
        display: block;
      }

      .results-table-wrapper {
        display: none;
      }

      .result-card-mobile {
        background: var(--bg-surface);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin-bottom: var(--space-3);
      }

      .result-card-mobile.error {
        background: #FEF2F2;
        border-color: var(--color-error);
      }

      .result-card-mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-3);
      }

      .result-card-mobile-id {
        font-weight: 600;
        color: var(--color-gray-900);
      }

      .result-card-mobile-line {
        font-size: 13px;
        color: var(--color-gray-500);
      }

      .result-card-mobile-force {
        font-size: 24px;
        font-weight: 700;
        color: var(--color-gray-900);
        margin: var(--space-3) 0;
      }

      .result-card-mobile-params {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-2);
        font-size: 12px;
        color: var(--color-gray-700);
      }
    }

    @media (min-width: 641px) {
      .batch-results-cards {
        display: none;
      }
    }

    @media (min-width: 641px) and (max-width: 1023px) {
      .result-value {
        font-size: 32px;
      }

      .header {
        margin-bottom: var(--space-6);
      }
    }

    /* Tables responsive */
    @media (max-width: 640px) {
      table {
        font-size: 12px;
      }

      th, td {
        padding: var(--space-2);
      }

      .table-container {
        overflow-x: auto;
      }
    }

    /* Loading State */
    .btn-loading {
      position: relative;
      color: transparent;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid white;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spinner 0.6s linear infinite;
    }

    @keyframes spinner {
      to { transform: rotate(360deg); }
    }

    /* Print Styles */
    @media print {
      body {
        background: white;
      }

      .mode-switcher,
      .action-group,
      .reference-section,
      .input-method-selector,
      .batch-form-actions,
      .export-actions,
      .session-restore-banner {
        display: none !important;
      }

      .result-card,
      .batch-form-container {
        box-shadow: none;
        border: 1px solid var(--color-gray-300);
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="appContainer">
    <!-- Header -->
    <div class="header">
      <h1>PSV Reaction Force Calculator</h1>
      <p>Calcul de la force de reaction d'une soupape de surete selon F = Kf x A x P1</p>
    </div>

    <!-- Mode Switcher -->
    <div class="mode-switcher">
      <button class="mode-btn active" data-mode="simple" id="modeSimpleBtn">Calcul Simple</button>
      <button class="mode-btn" data-mode="batch" id="modeBatchBtn">Calcul Batch</button>
    </div>

    <!-- ==================== -->
    <!-- SIMPLE MODE SECTION  -->
    <!-- ==================== -->
    <div class="simple-section" id="simpleSection">
      <!-- Main Layout -->
      <div class="calc-layout">
        <!-- Left Column: Input Parameters -->
        <div class="input-section">
          <div class="param-card">
            <h4>Parametres de la soupape</h4>

            <div class="param-group">
              <label for="dn">DN (Diametre Nominal) <span class="required">*</span></label>
              <select id="dn" required>
                <option value="">Selectionner...</option>
                <option value="50">DN 50 (2")</option>
                <option value="65">DN 65 (2"1/2)</option>
                <option value="80">DN 80 (3")</option>
                <option value="100">DN 100 (4")</option>
                <option value="150">DN 150 (6")</option>
                <option value="200">DN 200 (8")</option>
                <option value=">200">DN > 200 (> 8")</option>
              </select>
              <span class="helper-text">Diametre nominal de sortie de la soupape</span>
            </div>

            <div class="param-group">
              <label for="fluidType">Type de fluide <span class="required">*</span></label>
              <select id="fluidType" required>
                <option value="">Selectionner...</option>
                <option value="gaz">Gaz</option>
                <option value="vapeur eau">Vapeur d'eau</option>
              </select>
              <span class="helper-text">Nature du fluide de process</span>
            </div>

            <div class="param-group">
              <label for="orifice">Orifice <span class="required">*</span></label>
              <select id="orifice" required>
                <option value="">Selectionner...</option>
                <option value="D">D (0,71 cm2)</option>
                <option value="E">E (1,26 cm2)</option>
                <option value="F">F (1,98 cm2)</option>
                <option value="G">G (3,24 cm2)</option>
                <option value="H">H (5,06 cm2)</option>
                <option value="J">J (8,3 cm2)</option>
                <option value="K">K (11,86 cm2)</option>
                <option value="L">L (18,41 cm2)</option>
                <option value="M">M (23,2 cm2)</option>
                <option value="N">N (28 cm2)</option>
                <option value="P">P (41,2 cm2)</option>
                <option value="Q">Q (71,2 cm2)</option>
                <option value="R">R (103 cm2)</option>
                <option value="T">T (168 cm2)</option>
                <option value="V">V (271 cm2)</option>
                <option value="W">W (406 cm2)</option>
              </select>
              <span class="helper-text">Lettre de l'orifice selon ASME</span>
            </div>

            <div class="param-group">
              <label for="pressure">Pression de decharge <span class="required">*</span></label>
              <div class="input-with-unit">
                <input type="number" id="pressure" min="0" step="0.1" placeholder="0.0" required>
                <select class="unit-select" id="pressureUnit">
                  <option value="bar">bar abs</option>
                </select>
              </div>
              <span class="helper-text">P1 = Pression absolue incluant la surpression</span>
            </div>
          </div>

          <!-- Formula Box -->
          <div class="formula-box">
            <h5>Formule de calcul</h5>
            <div class="formula">F = Kf x A x P1</div>
            <div class="formula-legend">
              <strong>Kf :</strong> Facteur dependant du fluide et du DN<br>
              <strong>A :</strong> Section d'orifice de la soupape (cm2)<br>
              <strong>P1 :</strong> Pression de decharge absolue (bar)<br>
              <strong>F :</strong> Force de reaction (daN)
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-group">
            <button class="btn btn-primary btn-large" id="calculateBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="2" width="16" height="20" rx="2"/>
                <line x1="8" y1="6" x2="16" y2="6"/>
                <line x1="8" y1="10" x2="16" y2="10"/>
                <line x1="8" y1="14" x2="16" y2="14"/>
                <line x1="8" y1="18" x2="10" y2="18"/>
              </svg>
              Calculer
            </button>
            <button class="btn btn-secondary" id="resetBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
              </svg>
              Reinitialiser
            </button>
          </div>
        </div>

        <!-- Right Column: Results -->
        <div class="results-section" id="resultsSection">
          <div class="result-card">
            <h3>Resultats du calcul</h3>

            <div class="result-item">
              <span class="result-label">Force de reaction</span>
              <div class="result-value-group">
                <span class="result-value" id="forceValue">-</span>
                <span class="result-unit">daN</span>
              </div>
              <span class="badge badge-success" id="statusBadge">Calcule</span>
            </div>

            <div class="result-item">
              <span class="result-label">Parametres utilises</span>
              <div style="font-size: 13px; color: var(--color-gray-700); line-height: 1.8;">
                <div id="paramsSummary"></div>
              </div>
            </div>
          </div>

          <div class="action-group">
            <button class="btn btn-secondary" id="copyBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              Copier le resultat
            </button>
            <button class="btn btn-secondary" id="printBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"/>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                <rect x="6" y="14" width="12" height="8"/>
              </svg>
              Imprimer / PDF
            </button>
          </div>
        </div>
      </div>

      <!-- Reference Tables -->
      <div class="reference-section">
        <h3>Tables de reference</h3>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>DN (mm)</th>
                <th>Taille (pouces)</th>
                <th>Kf Gaz</th>
                <th>Kf Vapeur d'eau</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>50</td><td>2"</td><td>1,9</td><td>2,0</td></tr>
              <tr><td>65</td><td>2"1/2</td><td>1,9</td><td>2,0</td></tr>
              <tr><td>80</td><td>3"</td><td>1,5</td><td>1,6</td></tr>
              <tr><td>100</td><td>4"</td><td>1,5</td><td>1,6</td></tr>
              <tr><td>150</td><td>6"</td><td>1,3</td><td>1,3</td></tr>
              <tr><td>200</td><td>8"</td><td>1,1</td><td>1,1</td></tr>
              <tr><td>> 200</td><td>> 8"</td><td>1,1</td><td>1,1</td></tr>
            </tbody>
          </table>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Orifice</th>
                <th>Section (cm2)</th>
                <th>Orifice</th>
                <th>Section (cm2)</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>D</td><td>0,71</td><td>K</td><td>11,86</td></tr>
              <tr><td>E</td><td>1,26</td><td>L</td><td>18,41</td></tr>
              <tr><td>F</td><td>1,98</td><td>M</td><td>23,2</td></tr>
              <tr><td>G</td><td>3,24</td><td>N</td><td>28</td></tr>
              <tr><td>H</td><td>5,06</td><td>P</td><td>41,2</td></tr>
              <tr><td>J</td><td>8,3</td><td>Q</td><td>71,2</td></tr>
              <tr><td></td><td></td><td>R</td><td>103</td></tr>
              <tr><td></td><td></td><td>T</td><td>168</td></tr>
              <tr><td></td><td></td><td>V</td><td>271</td></tr>
              <tr><td></td><td></td><td>W</td><td>406</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ==================== -->
    <!-- BATCH MODE SECTION   -->
    <!-- ==================== -->
    <div class="batch-section" id="batchSection">
      <!-- Session Restore Banner -->
      <div class="session-restore-banner" id="sessionRestoreBanner">
        <div class="session-restore-text">
          <span>&#9888;</span>
          <span>Une session precedente a ete detectee. Voulez-vous la restaurer ?</span>
        </div>
        <div class="session-restore-actions">
          <button class="btn btn-small btn-primary" id="restoreSessionBtn">Restaurer</button>
          <button class="btn btn-small btn-secondary" id="discardSessionBtn">Ignorer</button>
        </div>
      </div>

      <!-- Input Method Selector -->
      <div class="input-method-selector">
        <label class="input-method-option active" id="methodFormOption">
          <input type="radio" name="inputMethod" value="form" checked>
          <div class="method-label">Formulaire</div>
          <div class="method-desc">Saisie manuelle multi-lignes</div>
        </label>
        <label class="input-method-option" id="methodCsvOption">
          <input type="radio" name="inputMethod" value="csv">
          <div class="method-label">Import CSV</div>
          <div class="method-desc">Importer depuis un fichier</div>
        </label>
      </div>

      <!-- Batch Form -->
      <div class="batch-form-container" id="batchFormContainer">
        <div class="batch-form-header">
          <h4>Saisie des PSV</h4>
          <div class="batch-form-actions">
            <button class="btn btn-small btn-secondary" id="addRowBtn">+ Ajouter une ligne</button>
            <button class="btn btn-small btn-secondary" id="addFiveRowsBtn">+ Ajouter 5 lignes</button>
          </div>
        </div>

        <div class="batch-table-wrapper">
          <table class="batch-table" id="batchTable">
            <thead>
              <tr>
                <th class="row-number">#</th>
                <th>ITEM ID *</th>
                <th>Nom de ligne *</th>
                <th>DN *</th>
                <th>Fluide *</th>
                <th>Orifice *</th>
                <th>Pression (bar abs) *</th>
                <th class="action-cell"></th>
              </tr>
            </thead>
            <tbody id="batchTableBody">
              <!-- Rows will be generated by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Batch Action Buttons -->
        <div class="action-group">
          <button class="btn btn-primary btn-large" id="calculateBatchBtn" disabled>
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="4" y="2" width="16" height="20" rx="2"/>
              <line x1="8" y1="6" x2="16" y2="6"/>
              <line x1="8" y1="10" x2="16" y2="10"/>
              <line x1="8" y1="14" x2="16" y2="14"/>
              <line x1="8" y1="18" x2="10" y2="18"/>
            </svg>
            Calculer tout
          </button>
          <button class="btn btn-secondary" id="resetBatchBtn">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
            Reinitialiser
          </button>
        </div>
      </div>

      <!-- CSV Import Zone -->
      <div class="csv-import-zone" id="csvImportZone">
        <div class="batch-form-container">
          <div class="batch-form-header">
            <h4>Import CSV</h4>
            <button class="btn btn-small btn-secondary" id="downloadTemplateBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Telecharger le template CSV
            </button>
          </div>

          <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">&#128196;</div>
            <div class="drop-zone-text">Glissez votre fichier CSV ici</div>
            <div class="drop-zone-hint">ou cliquez pour selectionner</div>
            <div class="drop-zone-hint" style="margin-top: 8px;">Format attendu : CSV (UTF-8) | Taille max : 5 MB</div>
            <input type="file" class="file-input" id="csvFileInput" accept=".csv">
          </div>

          <!-- CSV Preview -->
          <div class="csv-preview" id="csvPreview">
            <div class="csv-preview-header">
              <h5>Fichier analyse : <span id="csvFileName"></span></h5>
              <div class="csv-preview-stats">
                <div class="csv-preview-stat">
                  <span class="badge badge-success" id="csvValidCount">0 valides</span>
                </div>
                <div class="csv-preview-stat">
                  <span class="badge badge-warning" id="csvWarningCount">0 avertissements</span>
                </div>
                <div class="csv-preview-stat">
                  <span class="badge badge-error" id="csvErrorCount">0 erreurs</span>
                </div>
              </div>
            </div>

            <div class="csv-errors-list" id="csvErrorsList" style="display: none;"></div>

            <div class="action-group">
              <button class="btn btn-secondary" id="cancelCsvBtn">Annuler</button>
              <button class="btn btn-primary" id="importCsvBtn">Importer les lignes valides</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Batch Results -->
      <div class="batch-results" id="batchResults">
        <div class="batch-form-container">
          <div class="batch-results-header">
            <h4>Resultats du calcul</h4>
            <div class="batch-results-stats">
              <span class="badge badge-success" id="resultsValidCount">0 valides</span>
              <span class="badge badge-error" id="resultsErrorCount">0 erreurs</span>
            </div>
          </div>

          <!-- Desktop Table -->
          <div class="results-table-wrapper">
            <table class="results-table" id="resultsTable">
              <thead>
                <tr>
                  <th>ITEM ID</th>
                  <th>Nom de ligne</th>
                  <th>DN</th>
                  <th>Fluide</th>
                  <th>Orifice</th>
                  <th>P1 (bar)</th>
                  <th>Kf</th>
                  <th>A (cm2)</th>
                  <th>Force (daN)</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody id="resultsTableBody">
                <!-- Results will be generated by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Mobile Cards -->
          <div class="batch-results-cards" id="resultsCards">
            <!-- Cards will be generated by JavaScript -->
          </div>

          <!-- Export Actions -->
          <div class="export-actions">
            <button class="btn btn-secondary" id="exportCsvBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Telecharger CSV
            </button>
            <button class="btn btn-secondary" id="exportPdfBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
              </svg>
              Exporter PDF
            </button>
            <button class="btn btn-secondary" id="copyResultsBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              Copier dans presse-papier
            </button>
          </div>
        </div>
      </div>

      <!-- Formula Reference for Batch -->
      <div class="formula-box" style="margin-top: var(--space-6);">
        <h5>Formule de calcul</h5>
        <div class="formula">F = Kf x A x P1</div>
        <div class="formula-legend">
          <strong>Kf :</strong> Facteur dependant du fluide et du DN |
          <strong>A :</strong> Section d'orifice (cm2) |
          <strong>P1 :</strong> Pression de decharge absolue (bar) |
          <strong>F :</strong> Force de reaction (daN)
        </div>
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span id="toastMessage"></span>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Calcul en cours...</div>
  </div>

  <script>
    // ============================
    // DATA TABLES
    // ============================
    const kfTable = {
      '50': { 'gaz': 1.9, 'vapeur eau': 2.0 },
      '65': { 'gaz': 1.9, 'vapeur eau': 2.0 },
      '80': { 'gaz': 1.5, 'vapeur eau': 1.6 },
      '100': { 'gaz': 1.5, 'vapeur eau': 1.6 },
      '150': { 'gaz': 1.3, 'vapeur eau': 1.3 },
      '200': { 'gaz': 1.1, 'vapeur eau': 1.1 },
      '>200': { 'gaz': 1.1, 'vapeur eau': 1.1 }
    };

    const areaTable = {
      'D': 0.71, 'E': 1.26, 'F': 1.98, 'G': 3.24, 'H': 5.06,
      'J': 8.3, 'K': 11.86, 'L': 18.41, 'M': 23.2, 'N': 28,
      'P': 41.2, 'Q': 71.2, 'R': 103, 'T': 168, 'V': 271, 'W': 406
    };

    const validDNs = ['50', '65', '80', '100', '150', '200', '>200'];
    const validFluids = ['gaz', 'vapeur eau'];
    const validOrifices = ['D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R', 'T', 'V', 'W'];

    // ============================
    // APPLICATION STATE
    // ============================
    let appState = {
      mode: 'simple',
      batchInputMethod: 'form',
      psvList: [],
      calculated: false,
      results: [],
      stats: { total: 0, valid: 0, errors: 0, empty: 0 }
    };

    // ============================
    // DOM ELEMENTS - SIMPLE MODE
    // ============================
    const dnInput = document.getElementById('dn');
    const fluidTypeInput = document.getElementById('fluidType');
    const orificeInput = document.getElementById('orifice');
    const pressureInput = document.getElementById('pressure');
    const calculateBtn = document.getElementById('calculateBtn');
    const resetBtn = document.getElementById('resetBtn');
    const copyBtn = document.getElementById('copyBtn');
    const printBtn = document.getElementById('printBtn');
    const resultsSection = document.getElementById('resultsSection');
    const forceValue = document.getElementById('forceValue');
    const paramsSummary = document.getElementById('paramsSummary');

    // ============================
    // DOM ELEMENTS - MODE SWITCHING
    // ============================
    const modeSimpleBtn = document.getElementById('modeSimpleBtn');
    const modeBatchBtn = document.getElementById('modeBatchBtn');
    const simpleSection = document.getElementById('simpleSection');
    const batchSection = document.getElementById('batchSection');
    const appContainer = document.getElementById('appContainer');

    // ============================
    // DOM ELEMENTS - BATCH MODE
    // ============================
    const methodFormOption = document.getElementById('methodFormOption');
    const methodCsvOption = document.getElementById('methodCsvOption');
    const batchFormContainer = document.getElementById('batchFormContainer');
    const csvImportZone = document.getElementById('csvImportZone');
    const batchTableBody = document.getElementById('batchTableBody');
    const addRowBtn = document.getElementById('addRowBtn');
    const addFiveRowsBtn = document.getElementById('addFiveRowsBtn');
    const calculateBatchBtn = document.getElementById('calculateBatchBtn');
    const resetBatchBtn = document.getElementById('resetBatchBtn');
    const batchResults = document.getElementById('batchResults');
    const resultsTableBody = document.getElementById('resultsTableBody');
    const resultsCards = document.getElementById('resultsCards');

    // CSV Import Elements
    const dropZone = document.getElementById('dropZone');
    const csvFileInput = document.getElementById('csvFileInput');
    const csvPreview = document.getElementById('csvPreview');
    const csvFileName = document.getElementById('csvFileName');
    const csvValidCount = document.getElementById('csvValidCount');
    const csvWarningCount = document.getElementById('csvWarningCount');
    const csvErrorCount = document.getElementById('csvErrorCount');
    const csvErrorsList = document.getElementById('csvErrorsList');
    const cancelCsvBtn = document.getElementById('cancelCsvBtn');
    const importCsvBtn = document.getElementById('importCsvBtn');
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');

    // Export Elements
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const copyResultsBtn = document.getElementById('copyResultsBtn');

    // Session Restore Elements
    const sessionRestoreBanner = document.getElementById('sessionRestoreBanner');
    const restoreSessionBtn = document.getElementById('restoreSessionBtn');
    const discardSessionBtn = document.getElementById('discardSessionBtn');

    // Toast & Loading
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');

    // ============================
    // UTILITY FUNCTIONS
    // ============================
    function showToast(message, type = 'success') {
      toast.className = 'toast show ' + type;
      toastMessage.textContent = message;
      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }

    function showLoading(text = 'Calcul en cours...') {
      loadingText.textContent = text;
      loadingOverlay.classList.add('show');
    }

    function hideLoading() {
      loadingOverlay.classList.remove('show');
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ============================
    // MODE SWITCHING
    // ============================
    function switchMode(mode) {
      appState.mode = mode;

      // Update URL
      const url = new URL(window.location);
      if (mode === 'batch') {
        url.searchParams.set('mode', 'batch');
      } else {
        url.searchParams.delete('mode');
      }
      window.history.replaceState({}, '', url);

      // Update UI
      modeSimpleBtn.classList.toggle('active', mode === 'simple');
      modeBatchBtn.classList.toggle('active', mode === 'batch');
      simpleSection.classList.toggle('hide', mode === 'batch');
      batchSection.classList.toggle('show', mode === 'batch');
      appContainer.classList.toggle('batch-mode', mode === 'batch');

      // Check for saved session in batch mode
      if (mode === 'batch') {
        checkSavedSession();
      }
    }

    modeSimpleBtn.addEventListener('click', () => switchMode('simple'));
    modeBatchBtn.addEventListener('click', () => switchMode('batch'));

    // Check URL for mode on load
    function checkUrlMode() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('mode') === 'batch') {
        switchMode('batch');
      }
    }

    // ============================
    // SIMPLE MODE FUNCTIONS
    // ============================
    function validateInputs() {
      const isValid = dnInput.value && fluidTypeInput.value &&
                      orificeInput.value && pressureInput.value > 0;
      calculateBtn.disabled = !isValid;
      return isValid;
    }

    [dnInput, fluidTypeInput, orificeInput, pressureInput].forEach(input => {
      input.addEventListener('input', validateInputs);
    });

    function calculateForce() {
      if (!validateInputs()) return;

      calculateBtn.classList.add('btn-loading');
      calculateBtn.disabled = true;

      setTimeout(() => {
        const dn = dnInput.value;
        const fluidType = fluidTypeInput.value;
        const orifice = orificeInput.value;
        const pressure = parseFloat(pressureInput.value);

        const kf = kfTable[dn][fluidType];
        const area = areaTable[orifice];
        const force = kf * area * pressure;

        forceValue.textContent = force.toFixed(2);

        paramsSummary.innerHTML = `
          <strong>DN:</strong> ${dn}<br>
          <strong>Fluide:</strong> ${fluidType === 'gaz' ? 'Gaz' : 'Vapeur d\'eau'}<br>
          <strong>Orifice:</strong> ${orifice} (${area} cm2)<br>
          <strong>Kf:</strong> ${kf}<br>
          <strong>P1:</strong> ${pressure.toFixed(2)} bar abs
        `;

        resultsSection.classList.add('show');

        if (window.innerWidth < 1024) {
          setTimeout(() => {
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        }

        calculateBtn.classList.remove('btn-loading');
        calculateBtn.disabled = false;
      }, 300);
    }

    function resetForm() {
      dnInput.value = '';
      fluidTypeInput.value = '';
      orificeInput.value = '';
      pressureInput.value = '';
      resultsSection.classList.remove('show');
      validateInputs();
    }

    function copyResult() {
      const force = forceValue.textContent;
      const text = `Force de reaction: ${force} daN`;

      navigator.clipboard.writeText(text).then(() => {
        showToast('Resultat copie dans le presse-papier');
      });
    }

    function printResult() {
      window.print();
    }

    calculateBtn.addEventListener('click', calculateForce);
    resetBtn.addEventListener('click', resetForm);
    copyBtn.addEventListener('click', copyResult);
    printBtn.addEventListener('click', printResult);

    pressureInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !calculateBtn.disabled) {
        calculateForce();
      }
    });

    // ============================
    // BATCH MODE - INPUT METHOD
    // ============================
    function switchInputMethod(method) {
      appState.batchInputMethod = method;

      methodFormOption.classList.toggle('active', method === 'form');
      methodCsvOption.classList.toggle('active', method === 'csv');

      batchFormContainer.style.display = method === 'form' ? 'block' : 'none';
      csvImportZone.classList.toggle('show', method === 'csv');
    }

    methodFormOption.addEventListener('click', () => switchInputMethod('form'));
    methodCsvOption.addEventListener('click', () => switchInputMethod('csv'));

    // ============================
    // BATCH MODE - FORM HANDLING
    // ============================
    function createEmptyPSV() {
      return {
        itemId: '',
        lineName: '',
        dn: '',
        fluidType: '',
        orifice: '',
        pressure: '',
        status: 'empty',
        errors: {}
      };
    }

    function generateDNOptions(selected = '') {
      return `
        <option value="">--</option>
        ${validDNs.map(dn => `<option value="${dn}" ${selected === dn ? 'selected' : ''}>${dn}</option>`).join('')}
      `;
    }

    function generateFluidOptions(selected = '') {
      return `
        <option value="">--</option>
        <option value="gaz" ${selected === 'gaz' ? 'selected' : ''}>Gaz</option>
        <option value="vapeur eau" ${selected === 'vapeur eau' ? 'selected' : ''}>Vapeur</option>
      `;
    }

    function generateOrificeOptions(selected = '') {
      return `
        <option value="">--</option>
        ${validOrifices.map(o => `<option value="${o}" ${selected === o ? 'selected' : ''}>${o}</option>`).join('')}
      `;
    }

    function renderBatchRow(psv, index) {
      const row = document.createElement('tr');
      row.dataset.index = index;
      row.innerHTML = `
        <td class="row-number">${index + 1}</td>
        <td class="input-cell">
          <input type="text"
                 class="batch-input"
                 data-field="itemId"
                 value="${psv.itemId || ''}"
                 placeholder="PSV-001"
                 maxlength="50">
          <div class="field-error" data-error="itemId"></div>
        </td>
        <td class="input-cell">
          <input type="text"
                 class="batch-input"
                 data-field="lineName"
                 value="${psv.lineName || ''}"
                 placeholder="Ligne vapeur HP"
                 maxlength="100">
          <div class="field-error" data-error="lineName"></div>
        </td>
        <td class="select-cell">
          <select class="batch-input" data-field="dn">
            ${generateDNOptions(psv.dn)}
          </select>
          <div class="field-error" data-error="dn"></div>
        </td>
        <td class="select-cell">
          <select class="batch-input" data-field="fluidType">
            ${generateFluidOptions(psv.fluidType)}
          </select>
          <div class="field-error" data-error="fluidType"></div>
        </td>
        <td class="select-cell">
          <select class="batch-input" data-field="orifice">
            ${generateOrificeOptions(psv.orifice)}
          </select>
          <div class="field-error" data-error="orifice"></div>
        </td>
        <td class="input-cell">
          <input type="number"
                 class="batch-input"
                 data-field="pressure"
                 value="${psv.pressure || ''}"
                 placeholder="0.0"
                 min="0"
                 max="999.99"
                 step="0.01">
          <div class="field-error" data-error="pressure"></div>
        </td>
        <td class="action-cell">
          <button class="delete-row-btn" title="Supprimer cette ligne">&#10005;</button>
        </td>
      `;
      return row;
    }

    function renderBatchTable() {
      batchTableBody.innerHTML = '';
      appState.psvList.forEach((psv, index) => {
        batchTableBody.appendChild(renderBatchRow(psv, index));
      });
      attachBatchEventListeners();
      validateBatchForm();
    }

    function attachBatchEventListeners() {
      // Input change events
      document.querySelectorAll('.batch-input').forEach(input => {
        input.addEventListener('input', debounce((e) => {
          const row = e.target.closest('tr');
          const index = parseInt(row.dataset.index);
          const field = e.target.dataset.field;
          let value = e.target.value;

          if (field === 'pressure' && value) {
            value = parseFloat(value);
          }

          appState.psvList[index][field] = value;
          validateRow(index);
          validateBatchForm();
          saveToLocalStorage();
        }, 300));

        input.addEventListener('blur', (e) => {
          e.target.classList.add('touched');
          const row = e.target.closest('tr');
          const index = parseInt(row.dataset.index);
          validateRow(index);
        });
      });

      // Delete row buttons
      document.querySelectorAll('.delete-row-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          const index = parseInt(row.dataset.index);
          deleteRow(index);
        });
      });
    }

    function addRow() {
      appState.psvList.push(createEmptyPSV());
      renderBatchTable();

      // Focus on the new row's first input
      const lastRow = batchTableBody.lastElementChild;
      if (lastRow) {
        const firstInput = lastRow.querySelector('input[data-field="itemId"]');
        if (firstInput) firstInput.focus();
      }
    }

    function addFiveRows() {
      for (let i = 0; i < 5; i++) {
        appState.psvList.push(createEmptyPSV());
      }
      renderBatchTable();
    }

    function deleteRow(index) {
      const psv = appState.psvList[index];
      const hasData = psv.itemId || psv.lineName || psv.dn || psv.fluidType || psv.orifice || psv.pressure;

      if (hasData) {
        if (!confirm('Supprimer cette ligne ?')) {
          return;
        }
      }

      // Keep at least one row
      if (appState.psvList.length <= 1) {
        appState.psvList = [createEmptyPSV()];
      } else {
        appState.psvList.splice(index, 1);
      }

      renderBatchTable();
      saveToLocalStorage();
    }

    function initBatchForm() {
      // Initialize with 5 empty rows
      appState.psvList = [];
      for (let i = 0; i < 5; i++) {
        appState.psvList.push(createEmptyPSV());
      }
      renderBatchTable();
    }

    addRowBtn.addEventListener('click', addRow);
    addFiveRowsBtn.addEventListener('click', addFiveRows);

    // ============================
    // BATCH MODE - VALIDATION
    // ============================
    function validatePSV(psv, index) {
      const errors = {};

      // Check if row is empty
      const isEmpty = !psv.itemId && !psv.lineName && !psv.dn &&
                      !psv.fluidType && !psv.orifice && !psv.pressure;
      if (isEmpty) {
        return { isValid: false, isEmpty: true, errors };
      }

      // ITEM ID
      if (!psv.itemId || psv.itemId.trim() === '') {
        errors.itemId = 'Requis';
      } else if (psv.itemId.length > 50) {
        errors.itemId = 'Max 50 caracteres';
      } else {
        // Check for duplicates
        const duplicate = appState.psvList.findIndex((p, i) =>
          i !== index && p.itemId && p.itemId.toLowerCase() === psv.itemId.toLowerCase()
        );
        if (duplicate !== -1) {
          errors.itemId = `Doublon (ligne ${duplicate + 1})`;
        }
      }

      // Line Name
      if (!psv.lineName || psv.lineName.trim() === '') {
        errors.lineName = 'Requis';
      } else if (psv.lineName.length > 100) {
        errors.lineName = 'Max 100 caracteres';
      }

      // DN
      if (!psv.dn) {
        errors.dn = 'Requis';
      } else if (!validDNs.includes(psv.dn)) {
        errors.dn = 'Invalide';
      }

      // Fluid Type
      if (!psv.fluidType) {
        errors.fluidType = 'Requis';
      } else if (!validFluids.includes(psv.fluidType)) {
        errors.fluidType = 'Invalide';
      }

      // Orifice
      if (!psv.orifice) {
        errors.orifice = 'Requis';
      } else if (!validOrifices.includes(psv.orifice)) {
        errors.orifice = 'Invalide';
      }

      // Pressure
      const pressure = parseFloat(psv.pressure);
      if (!psv.pressure && psv.pressure !== 0) {
        errors.pressure = 'Requis';
      } else if (isNaN(pressure) || pressure <= 0) {
        errors.pressure = 'Doit etre > 0';
      } else if (pressure > 999.99) {
        errors.pressure = 'Max 999.99';
      }

      return {
        isValid: Object.keys(errors).length === 0,
        isEmpty: false,
        errors
      };
    }

    function validateRow(index) {
      const psv = appState.psvList[index];
      const validation = validatePSV(psv, index);
      psv.errors = validation.errors;
      psv.status = validation.isEmpty ? 'empty' : (validation.isValid ? 'valid' : 'error');

      // Update UI
      const row = batchTableBody.querySelector(`tr[data-index="${index}"]`);
      if (row) {
        // Clear previous states
        row.querySelectorAll('.batch-input').forEach(input => {
          input.classList.remove('valid', 'invalid');
        });
        row.querySelectorAll('.field-error').forEach(el => {
          el.textContent = '';
        });

        // Apply new states
        Object.entries(psv.errors).forEach(([field, message]) => {
          const input = row.querySelector(`[data-field="${field}"]`);
          const errorEl = row.querySelector(`[data-error="${field}"]`);
          if (input) input.classList.add('invalid');
          if (errorEl) errorEl.textContent = message;
        });

        // Mark valid fields
        if (!validation.isEmpty) {
          ['itemId', 'lineName', 'dn', 'fluidType', 'orifice', 'pressure'].forEach(field => {
            if (!psv.errors[field] && psv[field]) {
              const input = row.querySelector(`[data-field="${field}"]`);
              if (input && input.classList.contains('touched')) {
                input.classList.add('valid');
              }
            }
          });
        }
      }

      return validation;
    }

    function validateBatchForm() {
      let validCount = 0;
      let errorCount = 0;
      let emptyCount = 0;

      appState.psvList.forEach((psv, index) => {
        const validation = validatePSV(psv, index);
        if (validation.isEmpty) {
          emptyCount++;
        } else if (validation.isValid) {
          validCount++;
        } else {
          errorCount++;
        }
      });

      appState.stats = {
        total: appState.psvList.length,
        valid: validCount,
        errors: errorCount,
        empty: emptyCount
      };

      // Enable/disable calculate button
      calculateBatchBtn.disabled = validCount === 0;

      return appState.stats;
    }

    // ============================
    // BATCH MODE - CALCULATION
    // ============================
    function calculatePSVForce(psv, index) {
      const validation = validatePSV(psv, index);

      if (validation.isEmpty) {
        return { ...psv, status: 'empty' };
      }

      if (!validation.isValid) {
        return {
          ...psv,
          status: 'error',
          errors: validation.errors,
          errorMessage: Object.values(validation.errors)[0]
        };
      }

      const kf = kfTable[psv.dn][psv.fluidType];
      const area = areaTable[psv.orifice];
      const pressure = parseFloat(psv.pressure);
      const force = kf * area * pressure;

      return {
        ...psv,
        kf,
        area,
        force: parseFloat(force.toFixed(2)),
        status: 'calculated',
        errors: {}
      };
    }

    function calculateBatch() {
      showLoading('Calcul en cours...');

      setTimeout(() => {
        appState.results = [];
        let validCount = 0;
        let errorCount = 0;

        appState.psvList.forEach((psv, index) => {
          const result = calculatePSVForce(psv, index);
          if (result.status !== 'empty') {
            appState.results.push(result);
            if (result.status === 'calculated') {
              validCount++;
            } else {
              errorCount++;
            }
          }
        });

        appState.calculated = true;
        appState.stats.valid = validCount;
        appState.stats.errors = errorCount;

        renderResults();
        hideLoading();

        // Show results section
        batchResults.classList.add('show');

        // Scroll to results
        setTimeout(() => {
          batchResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);

        showToast(`Calcul termine : ${validCount} valides, ${errorCount} erreurs`);
      }, 300);
    }

    calculateBatchBtn.addEventListener('click', calculateBatch);

    // ============================
    // BATCH MODE - RESULTS DISPLAY
    // ============================
    function renderResults() {
      // Update stats
      document.getElementById('resultsValidCount').textContent = `${appState.stats.valid} valides`;
      document.getElementById('resultsErrorCount').textContent = `${appState.stats.errors} erreurs`;

      // Render table (desktop)
      resultsTableBody.innerHTML = '';
      appState.results.forEach(result => {
        const row = document.createElement('tr');
        if (result.status === 'error') {
          row.classList.add('row-error');
        }

        row.innerHTML = `
          <td class="text-left">${result.itemId || '-'}</td>
          <td class="text-left">${result.lineName || '-'}</td>
          <td>${result.dn || '-'}</td>
          <td>${result.fluidType === 'vapeur eau' ? 'Vapeur' : (result.fluidType || '-')}</td>
          <td>${result.orifice || '-'}</td>
          <td class="text-right">${result.pressure ? parseFloat(result.pressure).toFixed(2) : '-'}</td>
          <td class="text-right">${result.kf || '-'}</td>
          <td class="text-right">${result.area || '-'}</td>
          <td class="force-cell text-right">${result.force ? result.force.toFixed(2) : '-'}</td>
          <td>
            ${result.status === 'calculated'
              ? '<span class="badge badge-success">Valide</span>'
              : `<span class="badge badge-error">${result.errorMessage || 'Erreur'}</span>`}
          </td>
        `;
        resultsTableBody.appendChild(row);
      });

      // Render cards (mobile)
      resultsCards.innerHTML = '';
      appState.results.forEach(result => {
        const card = document.createElement('div');
        card.className = `result-card-mobile ${result.status === 'error' ? 'error' : ''}`;

        card.innerHTML = `
          <div class="result-card-mobile-header">
            <div>
              <div class="result-card-mobile-id">${result.itemId || '-'}</div>
              <div class="result-card-mobile-line">${result.lineName || '-'}</div>
            </div>
            ${result.status === 'calculated'
              ? '<span class="badge badge-success">Valide</span>'
              : `<span class="badge badge-error">${result.errorMessage || 'Erreur'}</span>`}
          </div>
          <div class="result-card-mobile-force">
            ${result.force ? result.force.toFixed(2) + ' daN' : '-'}
          </div>
          <div class="result-card-mobile-params">
            <div><strong>DN:</strong> ${result.dn || '-'}</div>
            <div><strong>Fluide:</strong> ${result.fluidType === 'vapeur eau' ? 'Vapeur' : (result.fluidType || '-')}</div>
            <div><strong>Orifice:</strong> ${result.orifice || '-'}</div>
            <div><strong>P1:</strong> ${result.pressure ? parseFloat(result.pressure).toFixed(2) + ' bar' : '-'}</div>
            <div><strong>Kf:</strong> ${result.kf || '-'}</div>
            <div><strong>A:</strong> ${result.area ? result.area + ' cm2' : '-'}</div>
          </div>
        `;
        resultsCards.appendChild(card);
      });
    }

    // ============================
    // BATCH MODE - RESET
    // ============================
    function resetBatch() {
      if (confirm('Reinitialiser toutes les donnees ?')) {
        appState.psvList = [];
        appState.results = [];
        appState.calculated = false;
        appState.stats = { total: 0, valid: 0, errors: 0, empty: 0 };

        batchResults.classList.remove('show');
        csvPreview.classList.remove('show');

        initBatchForm();
        clearLocalStorage();

        showToast('Formulaire reinitialise');
      }
    }

    resetBatchBtn.addEventListener('click', resetBatch);

    // ============================
    // CSV IMPORT
    // ============================
    let parsedCSVData = [];

    // Drag and drop
    dropZone.addEventListener('click', () => csvFileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) handleCSVFile(file);
    });

    csvFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleCSVFile(file);
    });

    function handleCSVFile(file) {
      // Validate file
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showToast('Veuillez selectionner un fichier CSV', 'error');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        showToast('Le fichier est trop volumineux (max 5 MB)', 'error');
        return;
      }

      // Parse CSV
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        encoding: 'UTF-8',
        complete: function(results) {
          processCSVData(results, file.name);
        },
        error: function(error) {
          showToast('Erreur lors de la lecture du fichier: ' + error.message, 'error');
        }
      });
    }

    function normalizeCSVHeaders(row) {
      const normalized = {};
      const headerMap = {
        'item_id': 'itemId',
        'itemid': 'itemId',
        'item id': 'itemId',
        'line_name': 'lineName',
        'linename': 'lineName',
        'line name': 'lineName',
        'nom_ligne': 'lineName',
        'nom de ligne': 'lineName',
        'dn': 'dn',
        'fluid_type': 'fluidType',
        'fluidtype': 'fluidType',
        'fluid type': 'fluidType',
        'fluide': 'fluidType',
        'type_fluide': 'fluidType',
        'orifice': 'orifice',
        'pressure': 'pressure',
        'pression': 'pressure',
        'pressure_bar': 'pressure',
        'p1': 'pressure'
      };

      Object.keys(row).forEach(key => {
        const normalizedKey = key.toLowerCase().trim();
        const mappedKey = headerMap[normalizedKey];
        if (mappedKey) {
          normalized[mappedKey] = row[key];
        }
      });

      return normalized;
    }

    function normalizeFluidType(value) {
      if (!value) return '';
      const v = value.toLowerCase().trim();
      if (v === 'gaz' || v === 'gas') return 'gaz';
      if (v === 'vapeur eau' || v === 'vapeur' || v === 'steam' || v === 'vapeur d\'eau') return 'vapeur eau';
      return value;
    }

    function normalizeDN(value) {
      if (!value) return '';
      const v = value.toString().trim();
      if (v === '>200' || v === '> 200' || v === 'more than 200') return '>200';
      return v;
    }

    function processCSVData(results, fileName) {
      parsedCSVData = [];
      const errors = [];
      let validCount = 0;
      let warningCount = 0;
      let errorCount = 0;

      results.data.forEach((row, index) => {
        const lineNum = index + 2; // Account for header row
        const normalized = normalizeCSVHeaders(row);

        // Skip completely empty rows
        const isEmpty = !normalized.itemId && !normalized.lineName &&
                       !normalized.dn && !normalized.fluidType &&
                       !normalized.orifice && !normalized.pressure;
        if (isEmpty) return;

        const psv = {
          itemId: (normalized.itemId || '').trim(),
          lineName: (normalized.lineName || '').trim(),
          dn: normalizeDN(normalized.dn),
          fluidType: normalizeFluidType(normalized.fluidType),
          orifice: (normalized.orifice || '').toUpperCase().trim(),
          pressure: normalized.pressure ? parseFloat(normalized.pressure) : '',
          status: 'pending',
          errors: {},
          lineNum
        };

        // Validate
        const rowErrors = [];

        if (!psv.itemId) {
          rowErrors.push('ITEM_ID manquant');
        }
        if (!psv.lineName) {
          rowErrors.push('LINE_NAME manquant');
        }
        if (psv.dn && !validDNs.includes(psv.dn)) {
          rowErrors.push(`DN invalide "${normalized.dn}"`);
        }
        if (psv.fluidType && !validFluids.includes(psv.fluidType)) {
          rowErrors.push(`Fluide invalide "${normalized.fluidType}"`);
        }
        if (psv.orifice && !validOrifices.includes(psv.orifice)) {
          rowErrors.push(`Orifice invalide "${normalized.orifice}"`);
        }
        if (psv.pressure && (isNaN(psv.pressure) || psv.pressure <= 0)) {
          rowErrors.push(`Pression invalide "${normalized.pressure}"`);
        }

        if (rowErrors.length > 0) {
          errorCount++;
          errors.push(`Ligne ${lineNum}: ${rowErrors.join(', ')}`);
          psv.status = 'error';
          psv.errorMessage = rowErrors[0];
        } else if (!psv.dn || !psv.fluidType || !psv.orifice || !psv.pressure) {
          warningCount++;
          psv.status = 'warning';
        } else {
          validCount++;
          psv.status = 'valid';
        }

        parsedCSVData.push(psv);
      });

      // Display preview
      csvFileName.textContent = fileName;
      csvValidCount.textContent = `${validCount} valides`;
      csvWarningCount.textContent = `${warningCount} avertissements`;
      csvErrorCount.textContent = `${errorCount} erreurs`;

      if (errors.length > 0) {
        csvErrorsList.innerHTML = errors.map(e => `<div class="csv-error-item">${e}</div>`).join('');
        csvErrorsList.style.display = 'block';
      } else {
        csvErrorsList.style.display = 'none';
      }

      importCsvBtn.disabled = validCount === 0 && warningCount === 0;
      csvPreview.classList.add('show');
    }

    cancelCsvBtn.addEventListener('click', () => {
      csvPreview.classList.remove('show');
      csvFileInput.value = '';
      parsedCSVData = [];
    });

    importCsvBtn.addEventListener('click', () => {
      // Import valid and warning rows
      const toImport = parsedCSVData.filter(p => p.status === 'valid' || p.status === 'warning');

      if (toImport.length === 0) {
        showToast('Aucune ligne valide a importer', 'error');
        return;
      }

      // Add to psvList
      appState.psvList = toImport.map(p => ({
        itemId: p.itemId,
        lineName: p.lineName,
        dn: p.dn,
        fluidType: p.fluidType,
        orifice: p.orifice,
        pressure: p.pressure,
        status: 'pending',
        errors: {}
      }));

      // Switch to form view and render
      switchInputMethod('form');
      renderBatchTable();

      // Hide preview
      csvPreview.classList.remove('show');
      csvFileInput.value = '';
      parsedCSVData = [];

      saveToLocalStorage();
      showToast(`${toImport.length} lignes importees`);
    });

    // Download template
    downloadTemplateBtn.addEventListener('click', () => {
      const template = `ITEM_ID,LINE_NAME,DN,FLUID_TYPE,ORIFICE,PRESSURE
PSV-001,Ligne vapeur HP,100,gaz,K,15.5
PSV-002,Feed H2,150,vapeur eau,M,22.0
PSV-003,Depart C101,80,gaz,H,18.3
,,,,
,,,,
,,,,
,,,,
,,,,
,,,,
,,,,`;

      const blob = new Blob(['\ufeff' + template], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'template_psv_batch.csv';
      link.click();
      URL.revokeObjectURL(link.href);

      showToast('Template telecharge');
    });

    // ============================
    // EXPORT FUNCTIONS
    // ============================

    // Export CSV
    exportCsvBtn.addEventListener('click', () => {
      if (appState.results.length === 0) {
        showToast('Aucun resultat a exporter', 'error');
        return;
      }

      const headers = ['ITEM_ID', 'LINE_NAME', 'DN', 'FLUID_TYPE', 'ORIFICE', 'PRESSURE_BAR', 'KF', 'AREA_CM2', 'FORCE_DAN', 'STATUS', 'ERROR_MESSAGE'];

      const rows = appState.results.map(r => [
        r.itemId || '',
        r.lineName || '',
        r.dn || '',
        r.fluidType || '',
        r.orifice || '',
        r.pressure ? parseFloat(r.pressure).toFixed(2) : '',
        r.kf || '',
        r.area || '',
        r.force ? r.force.toFixed(2) : '',
        r.status === 'calculated' ? 'valid' : 'error',
        r.errorMessage || ''
      ]);

      const csv = [headers, ...rows].map(row => row.join(',')).join('\n');

      const now = new Date();
      const timestamp = now.toISOString().slice(0,10).replace(/-/g,'') + '_' +
                       now.toTimeString().slice(0,8).replace(/:/g,'');

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `psv_batch_results_${timestamp}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);

      showToast('CSV telecharge');
    });

    // Export PDF
    exportPdfBtn.addEventListener('click', () => {
      if (appState.results.length === 0) {
        showToast('Aucun resultat a exporter', 'error');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

      // Title
      doc.setFontSize(18);
      doc.text('PSV REACTION FORCE - CALCUL BATCH', 14, 20);

      // Date
      doc.setFontSize(10);
      const now = new Date();
      doc.text(`Date : ${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR')}`, 14, 28);

      // Summary
      doc.setFontSize(12);
      doc.text(`Resume : ${appState.results.length} PSV | ${appState.stats.valid} valides | ${appState.stats.errors} erreurs`, 14, 38);
      doc.text('Formule : F = Kf x A x P1', 14, 45);

      // Table
      const tableData = appState.results.map(r => [
        r.itemId || '-',
        r.lineName || '-',
        r.dn || '-',
        r.fluidType === 'vapeur eau' ? 'Vapeur' : (r.fluidType || '-'),
        r.orifice || '-',
        r.pressure ? parseFloat(r.pressure).toFixed(2) : '-',
        r.kf || '-',
        r.area || '-',
        r.force ? r.force.toFixed(2) : '-',
        r.status === 'calculated' ? 'Valide' : (r.errorMessage || 'Erreur')
      ]);

      doc.autoTable({
        startY: 52,
        head: [['ITEM ID', 'Nom ligne', 'DN', 'Fluide', 'Orifice', 'P1 (bar)', 'Kf', 'A (cm2)', 'Force (daN)', 'Statut']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [79, 124, 255], fontSize: 9 },
        bodyStyles: { fontSize: 8 },
        columnStyles: {
          0: { cellWidth: 25 },
          1: { cellWidth: 35 },
          8: { fontStyle: 'bold' }
        },
        didParseCell: function(data) {
          if (data.section === 'body' && data.column.index === 9) {
            if (data.cell.raw === 'Valide') {
              data.cell.styles.textColor = [5, 150, 105];
            } else {
              data.cell.styles.textColor = [220, 38, 38];
            }
          }
        }
      });

      // Legend
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(9);
      doc.text('Legende :', 14, finalY);
      doc.text('Kf : Facteur dependant du fluide et du DN | A : Section d\'orifice (cm2) | P1 : Pression decharge absolue (bar) | F : Force de reaction (daN)', 14, finalY + 5);

      // Save
      const timestamp = now.toISOString().slice(0,10).replace(/-/g,'');
      doc.save(`PSV_Batch_Results_${timestamp}.pdf`);

      showToast('PDF telecharge');
    });

    // Copy to clipboard
    copyResultsBtn.addEventListener('click', () => {
      if (appState.results.length === 0) {
        showToast('Aucun resultat a copier', 'error');
        return;
      }

      const headers = ['ITEM_ID', 'LINE_NAME', 'DN', 'FLUID_TYPE', 'ORIFICE', 'P1', 'KF', 'A', 'FORCE', 'STATUS'];

      const rows = appState.results.map(r => [
        r.itemId || '',
        r.lineName || '',
        r.dn || '',
        r.fluidType || '',
        r.orifice || '',
        r.pressure ? parseFloat(r.pressure).toFixed(2) : '',
        r.kf || '',
        r.area || '',
        r.force ? r.force.toFixed(2) : '',
        r.status === 'calculated' ? 'Valide' : 'Erreur'
      ].join('\t'));

      const tsv = [headers.join('\t'), ...rows].join('\n');

      navigator.clipboard.writeText(tsv).then(() => {
        showToast('Copie dans le presse-papier (format tableur)');
      }).catch(() => {
        showToast('Erreur lors de la copie', 'error');
      });
    });

    // ============================
    // LOCAL STORAGE
    // ============================
    function saveToLocalStorage() {
      try {
        localStorage.setItem('psv_calculator_mode', appState.mode);
        localStorage.setItem('psv_calculator_batch_data', JSON.stringify(appState.psvList));
        localStorage.setItem('psv_calculator_batch_timestamp', Date.now().toString());
      } catch (e) {
        console.error('Erreur sauvegarde localStorage:', e);
      }
    }

    function loadFromLocalStorage() {
      try {
        const batchData = localStorage.getItem('psv_calculator_batch_data');
        const timestamp = localStorage.getItem('psv_calculator_batch_timestamp');

        // Restore if session is recent (< 24h)
        if (timestamp && Date.now() - parseInt(timestamp) < 24 * 60 * 60 * 1000) {
          if (batchData) {
            const data = JSON.parse(batchData);
            // Check if there's actual data
            const hasData = data.some(p => p.itemId || p.lineName || p.dn || p.fluidType || p.orifice || p.pressure);
            if (hasData) {
              return data;
            }
          }
        }
        return null;
      } catch (e) {
        console.error('Erreur chargement localStorage:', e);
        return null;
      }
    }

    function clearLocalStorage() {
      localStorage.removeItem('psv_calculator_batch_data');
      localStorage.removeItem('psv_calculator_batch_timestamp');
    }

    function checkSavedSession() {
      const savedData = loadFromLocalStorage();
      if (savedData && savedData.length > 0) {
        sessionRestoreBanner.classList.add('show');
      }
    }

    restoreSessionBtn.addEventListener('click', () => {
      const savedData = loadFromLocalStorage();
      if (savedData) {
        appState.psvList = savedData;
        renderBatchTable();
        showToast('Session restauree');
      }
      sessionRestoreBanner.classList.remove('show');
    });

    discardSessionBtn.addEventListener('click', () => {
      clearLocalStorage();
      sessionRestoreBanner.classList.remove('show');
    });

    // Auto-save every 30 seconds
    setInterval(() => {
      if (appState.mode === 'batch' && appState.psvList.length > 0) {
        const hasData = appState.psvList.some(p => p.itemId || p.lineName || p.dn || p.fluidType || p.orifice || p.pressure);
        if (hasData) {
          saveToLocalStorage();
        }
      }
    }, 30000);

    // ============================
    // INITIALIZATION
    // ============================
    function init() {
      // Check URL mode
      checkUrlMode();

      // Initialize simple mode validation
      validateInputs();

      // Initialize batch form
      initBatchForm();
    }

    // Run on DOM ready
    document.addEventListener('DOMContentLoaded', init);

    // Also run immediately if DOM already loaded
    if (document.readyState !== 'loading') {
      init();
    }
  </script>
</body>
</html>
