<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PSV Reaction Force Calculator</title>

  <!-- External Libraries via CDN -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>

  <style>
    /* Design System - CSS Variables (Maurice Design System) */
    :root {
      /* Primary Colors - Teal */
      --color-primary: #0D9488;
      --color-primary-dark: #0F766E;
      --color-primary-darker: #115E59;
      --color-primary-light: #F0FDFA;
      --color-primary-lighter: #CCFBF1;

      /* Accent - Black for primary buttons */
      --color-accent: #111827;
      --color-accent-dark: #1F2937;
      --color-accent-darker: #374151;

      /* Semantic Colors */
      --color-success: #0D9488;
      --color-success-light: #F0FDFA;
      --color-warning: #D97706;
      --color-warning-light: #FEF3C7;
      --color-error: #DC2626;
      --color-error-light: #FEE2E2;
      --color-info: #6B7280;

      /* Neutrals */
      --color-gray-50: #F9FAFB;
      --color-gray-100: #F3F4F6;
      --color-gray-200: #E5E7EB;
      --color-gray-300: #D1D5DB;
      --color-gray-400: #9CA3AF;
      --color-gray-500: #6B7280;
      --color-gray-600: #4B5563;
      --color-gray-700: #374151;
      --color-gray-800: #1F2937;
      --color-gray-900: #111827;

      /* Backgrounds */
      --bg-page: #F3F4F6;
      --bg-surface: #FFFFFF;

      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 20px;
      --space-6: 24px;
      --space-8: 32px;
      --space-10: 40px;

      /* Typography */
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', 'Consolas', monospace;

      /* Shadows - Subtle */
      --shadow-xs: 0 1px 2px rgba(0,0,0,0.04);
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px rgba(0,0,0,0.05), 0 2px 4px rgba(0,0,0,0.03);
      --shadow-lg: 0 10px 15px rgba(0,0,0,0.05), 0 4px 6px rgba(0,0,0,0.03);

      /* Focus Rings */
      --ring-primary: 0 0 0 3px rgba(13, 148, 136, 0.15);
      --ring-error: 0 0 0 3px rgba(220, 38, 38, 0.15);

      /* Border Radius */
      --radius-sm: 4px;
      --radius-md: 6px;
      --radius-lg: 8px;
      --radius-xl: 12px;
      --radius-full: 9999px;

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: var(--font-sans);
      background: var(--bg-page);
      color: var(--color-gray-900);
      line-height: 1.5;
      min-height: 100vh;
    }

    /* Container */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: var(--space-6) var(--space-4);
    }

    @media (min-width: 768px) {
      .container {
        padding: var(--space-8) var(--space-6);
      }
    }

    @media (min-width: 1024px) {
      .container {
        padding: var(--space-10) var(--space-8);
      }

      .container.batch-mode {
        max-width: 1400px;
      }
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: var(--space-6);
      padding: var(--space-6) var(--space-4);
      background: var(--bg-surface);
      border-radius: var(--radius-xl);
      box-shadow: var(--shadow-sm);
    }

    .header h1 {
      font-size: 32px;
      font-weight: 700;
      color: var(--color-gray-900);
      margin-bottom: var(--space-2);
      line-height: 1.25;
    }

    .header p {
      font-size: 16px;
      color: var(--color-gray-500);
      max-width: 600px;
      margin: 0 auto;
      line-height: 1.6;
    }

    /* Mode Switcher */
    .mode-switcher {
      display: flex;
      justify-content: center;
      gap: var(--space-2);
      margin-bottom: var(--space-6);
      padding: var(--space-1);
      background: var(--color-gray-100);
      border-radius: var(--radius-md);
      width: fit-content;
      margin-left: auto;
      margin-right: auto;
    }

    .mode-btn {
      padding: var(--space-3) var(--space-6);
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      font-size: 14px;
      font-weight: 500;
      color: var(--color-gray-700);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: var(--font-sans);
    }

    .mode-btn:hover {
      color: var(--color-gray-900);
    }

    .mode-btn.active {
      background: var(--bg-surface);
      color: var(--color-primary);
      box-shadow: var(--shadow-sm);
    }

    /* Main Layout - Desktop 2 columns */
    .calc-layout {
      display: block;
      margin-bottom: var(--space-8);
    }

    @media (min-width: 1024px) {
      .calc-layout {
        display: grid;
        grid-template-columns: 420px 1fr;
        gap: var(--space-6);
        align-items: start;
      }
    }

    /* Input Section */
    .input-section {
      margin-bottom: var(--space-6);
    }

    @media (min-width: 1024px) {
      .input-section {
        margin-bottom: 0;
        position: sticky;
        top: var(--space-4);
        max-height: calc(100vh - var(--space-8));
        overflow-y: auto;
      }
    }

    /* Parameter Card */
    .param-card {
      background: var(--bg-surface);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-6);
      margin-bottom: var(--space-4);
    }

    .param-card h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-gray-100);
    }

    .param-group {
      margin-bottom: var(--space-4);
    }

    .param-group:last-child {
      margin-bottom: 0;
    }

    label {
      display: block;
      font-size: 13px;
      font-weight: 500;
      color: var(--color-gray-700);
      margin-bottom: 6px;
    }

    .required {
      color: var(--color-error);
      margin-left: 2px;
    }

    /* Input with Unit */
    .input-with-unit {
      display: flex;
      gap: var(--space-2);
    }

    .input-with-unit input {
      flex: 1;
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    select, input[type="number"], input[type="text"] {
      width: 100%;
      height: 40px;
      padding: 10px 12px;
      border: 1px solid var(--color-gray-300);
      border-radius: var(--radius-md);
      font-size: 14px;
      font-family: var(--font-sans);
      color: var(--color-gray-900);
      background: var(--bg-surface);
      transition: all var(--transition-base);
    }

    select:focus, input[type="number"]:focus, input[type="text"]:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: var(--ring-primary);
    }

    .unit-select {
      width: 100px;
      background: var(--color-gray-50);
      font-size: 13px;
      color: var(--color-gray-700);
    }

    .helper-text {
      display: block;
      font-size: 12px;
      color: var(--color-gray-500);
      margin-top: 4px;
    }

    /* Formula Box */
    .formula-box {
      background: linear-gradient(135deg, #EFF6FF 0%, #DBEAFE 100%);
      border-left: 4px solid var(--color-info);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-top: var(--space-6);
    }

    .formula-box h5 {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-2);
    }

    .formula {
      font-family: 'Courier New', monospace;
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-3);
    }

    .formula-legend {
      font-size: 12px;
      color: var(--color-gray-700);
      line-height: 1.6;
    }

    /* Action Group */
    .action-group {
      display: flex;
      gap: var(--space-3);
      margin-top: var(--space-6);
      flex-wrap: wrap;
    }

    /* Buttons */
    .btn {
      padding: 12px 20px;
      border-radius: var(--radius-lg);
      font-size: 14px;
      font-weight: 600;
      font-family: var(--font-sans);
      border: none;
      cursor: pointer;
      transition: all var(--transition-fast);
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      justify-content: center;
      min-height: 44px;
    }

    .btn-primary {
      background: var(--color-accent);
      color: white;
    }

    .btn-primary:hover {
      background: var(--color-accent-dark);
    }

    .btn-primary:active {
      background: var(--color-accent-darker);
    }

    .btn-primary:disabled {
      background: var(--color-gray-300);
      color: var(--color-gray-400);
      cursor: not-allowed;
    }

    .btn-secondary {
      background: var(--bg-surface);
      color: var(--color-gray-700);
      border: 1px solid var(--color-gray-300);
    }

    .btn-secondary:hover {
      background: var(--color-gray-50);
    }

    .btn-secondary:active {
      background: var(--color-gray-100);
    }

    .btn-success {
      background: var(--color-success);
      color: white;
    }

    .btn-success:hover {
      background: var(--color-primary-dark);
    }

    .btn-large {
      height: 48px;
      padding: 12px 24px;
      font-size: 15px;
    }

    .btn-icon {
      width: 20px;
      height: 20px;
      fill: currentColor;
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 13px;
      min-height: 36px;
    }

    .btn-danger {
      background: transparent;
      color: var(--color-error);
      border: 1px solid var(--color-error);
    }

    .btn-danger:hover {
      background: var(--color-error-light);
    }

    /* Results Section */
    .results-section {
      display: none;
    }

    .results-section.show {
      display: block;
      animation: fadeIn 0.3s ease-in;
    }

    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .result-card {
      background: var(--bg-surface);
      border-left: 4px solid var(--color-success);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-4);
    }

    .result-card h3 {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-6);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-gray-100);
    }

    .result-item {
      padding: var(--space-4) 0;
      border-bottom: 1px solid var(--color-gray-100);
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-label {
      display: block;
      font-size: 14px;
      color: var(--color-gray-700);
      margin-bottom: var(--space-2);
    }

    .result-value-group {
      display: flex;
      align-items: baseline;
      gap: var(--space-2);
      margin-bottom: var(--space-1);
    }

    .result-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--color-gray-900);
      font-variant-numeric: tabular-nums;
      line-height: 1;
    }

    .result-unit {
      font-size: 16px;
      color: var(--color-gray-500);
    }

    /* Badge */
    .badge {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 10px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.02em;
    }

    .badge-success {
      background: var(--color-success);
      color: white;
    }

    .badge-error {
      background: var(--color-error-light);
      color: var(--color-error);
    }

    .badge-info {
      background: var(--color-gray-100);
      color: var(--color-gray-700);
    }

    .badge-warning {
      background: var(--color-warning-light);
      color: var(--color-warning);
    }

    /* Reference Tables */
    .reference-section {
      margin-top: var(--space-10);
      clear: both;
    }

    @media (min-width: 1024px) {
      .reference-section {
        margin-left: calc(420px + var(--space-6));
      }
    }

    .reference-section h3 {
      font-size: 20px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-6);
    }

    .table-container {
      background: var(--bg-surface);
      border-radius: var(--radius-xl);
      overflow: hidden;
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-6);
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--color-gray-50);
    }

    th {
      text-align: left;
      padding: var(--space-3) var(--space-4);
      font-size: 10px;
      font-weight: 600;
      color: var(--color-gray-400);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    td {
      padding: var(--space-3) var(--space-4);
      border-bottom: 1px solid var(--color-gray-200);
      font-size: 14px;
      color: var(--color-gray-900);
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: var(--color-gray-50);
    }

    /* ======================= */
    /* BATCH MODE STYLES       */
    /* ======================= */

    .batch-section {
      display: none;
    }

    .batch-section.show {
      display: block;
    }

    .simple-section {
      display: block;
    }

    .simple-section.hide {
      display: none;
    }

    /* Batch Input Method Selector */
    .input-method-selector {
      display: flex;
      gap: var(--space-4);
      margin-bottom: var(--space-6);
    }

    .input-method-option {
      flex: 1;
      padding: var(--space-4);
      border: 2px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: center;
    }

    .input-method-option:hover {
      border-color: var(--color-gray-300);
    }

    .input-method-option.active {
      border-color: var(--color-primary);
      background: rgba(79, 124, 255, 0.05);
    }

    .input-method-option input {
      display: none;
    }

    .input-method-option .method-label {
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-1);
    }

    .input-method-option .method-desc {
      font-size: 12px;
      color: var(--color-gray-500);
    }

    /* Batch Form Container */
    .batch-form-container {
      background: var(--bg-surface);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      box-shadow: var(--shadow-md);
      margin-bottom: var(--space-6);
    }

    .batch-form-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      padding-bottom: var(--space-3);
      border-bottom: 1px solid var(--color-gray-100);
    }

    .batch-form-header h4 {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-900);
    }

    .batch-form-actions {
      display: flex;
      gap: var(--space-2);
    }

    /* Batch Table */
    .batch-table-wrapper {
      overflow-x: auto;
      margin-bottom: var(--space-4);
    }

    /* Mobile input cards - hidden on desktop */
    .batch-input-cards {
      display: none;
    }

    .batch-table {
      width: 100%;
      min-width: 1100px;
      border-collapse: collapse;
    }

    .batch-table th {
      background: var(--color-gray-50);
      padding: var(--space-3);
      font-size: 10px;
      font-weight: 600;
      color: var(--color-gray-400);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: center;
      white-space: nowrap;
    }

    .batch-table td {
      padding: var(--space-2);
      border-bottom: 1px solid var(--color-gray-100);
      vertical-align: top;
    }

    .batch-table input,
    .batch-table select {
      height: 36px;
      font-size: 13px;
      padding: 6px 10px;
    }

    .batch-table .input-cell {
      min-width: 120px;
    }

    .batch-table .select-cell {
      min-width: 100px;
    }

    .batch-table .action-cell {
      width: 50px;
      text-align: center;
    }

    .batch-table .row-number {
      width: 40px;
      text-align: center;
      color: var(--color-gray-500);
      font-size: 12px;
      font-weight: 500;
    }

    .batch-table .delete-row-btn {
      background: transparent;
      border: none;
      color: var(--color-gray-400);
      cursor: pointer;
      padding: var(--space-2);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }

    .batch-table .delete-row-btn:hover {
      color: var(--color-error);
      background: #FEE2E2;
    }

    /* Input Validation States */
    .batch-table input.valid,
    .batch-table select.valid {
      border-color: var(--color-success);
    }

    .batch-table input.invalid,
    .batch-table select.invalid {
      border-color: var(--color-error);
      background: #FEF2F2;
    }

    .batch-table input.touched:invalid,
    .batch-table select.touched:invalid {
      border-color: var(--color-error);
    }

    .field-error {
      font-size: 11px;
      color: var(--color-error);
      margin-top: 2px;
    }

    /* CSV Import Zone */
    .csv-import-zone {
      display: none;
    }

    .csv-import-zone.show {
      display: block;
    }

    .drop-zone {
      border: 2px dashed var(--color-gray-300);
      border-radius: var(--radius-xl);
      padding: var(--space-10);
      text-align: center;
      transition: all var(--transition-fast);
      cursor: pointer;
    }

    .drop-zone:hover {
      border-color: var(--color-primary);
      background: rgba(79, 124, 255, 0.02);
    }

    .drop-zone.drag-over {
      border-color: var(--color-primary);
      background: rgba(79, 124, 255, 0.05);
      border-style: solid;
    }

    .drop-zone-icon {
      font-size: 48px;
      margin-bottom: var(--space-4);
    }

    .drop-zone-text {
      font-size: 16px;
      color: var(--color-gray-700);
      margin-bottom: var(--space-2);
    }

    .drop-zone-hint {
      font-size: 13px;
      color: var(--color-gray-500);
    }

    .file-input {
      display: none;
    }

    /* CSV Preview */
    .csv-preview {
      display: none;
      margin-top: var(--space-6);
    }

    .csv-preview.show {
      display: block;
    }

    .csv-preview-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
    }

    .csv-preview-stats {
      display: flex;
      gap: var(--space-4);
    }

    .csv-preview-stat {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 14px;
    }

    .csv-errors-list {
      background: #FEF2F2;
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      max-height: 200px;
      overflow-y: auto;
    }

    .csv-error-item {
      font-size: 13px;
      color: var(--color-error);
      padding: var(--space-1) 0;
    }

    /* Batch Results */
    .batch-results {
      display: none;
    }

    .batch-results.show {
      display: block;
    }

    .batch-results-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
      gap: var(--space-3);
    }

    .batch-results-stats {
      display: flex;
      gap: var(--space-4);
    }

    .results-table-wrapper {
      overflow-x: auto;
    }

    .results-table {
      width: 100%;
      min-width: 1400px;
      border-collapse: collapse;
    }

    .results-table th {
      background: var(--color-gray-50);
      padding: var(--space-3);
      font-size: 10px;
      font-weight: 600;
      color: var(--color-gray-400);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      text-align: center;
      white-space: nowrap;
      position: sticky;
      top: 0;
    }

    .results-table td {
      padding: var(--space-3);
      border-bottom: 1px solid var(--color-gray-200);
      font-size: 13px;
      text-align: center;
    }

    .results-table .text-left {
      text-align: left;
    }

    .results-table .text-right {
      text-align: right;
      font-variant-numeric: tabular-nums;
    }

    .results-table .force-cell {
      font-size: 16px;
      font-weight: 700;
      color: var(--color-gray-900);
    }

    .results-table tr.row-error {
      background: #FEF2F2;
    }

    .results-table tr.row-error td {
      color: var(--color-gray-500);
    }

    /* Export Actions */
    .export-actions {
      display: flex;
      gap: var(--space-3);
      justify-content: flex-end;
      margin-top: var(--space-4);
      flex-wrap: wrap;
    }

    /* Toast Notification */
    .toast {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      background: var(--color-gray-900);
      color: white;
      padding: var(--space-4) var(--space-6);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      z-index: 1000;
      display: none;
      animation: slideIn 0.3s ease;
    }

    .toast.show {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .toast.success {
      background: var(--color-success);
    }

    .toast.error {
      background: var(--color-error);
    }

    @keyframes slideIn {
      from {
        transform: translateY(20px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.9);
      z-index: 999;
      justify-content: center;
      align-items: center;
      flex-direction: column;
    }

    .loading-overlay.show {
      display: flex;
    }

    .loading-spinner {
      width: 48px;
      height: 48px;
      border: 4px solid var(--color-gray-200);
      border-top-color: var(--color-primary);
      border-radius: 50%;
      animation: spinner 0.8s linear infinite;
    }

    .loading-text {
      margin-top: var(--space-4);
      font-size: 14px;
      color: var(--color-gray-700);
    }

    /* Session Restore Banner */
    .session-restore-banner {
      display: none;
      background: #FEF3C7;
      border: 1px solid #F59E0B;
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      justify-content: space-between;
      align-items: center;
    }

    .session-restore-banner.show {
      display: flex;
    }

    .session-restore-text {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: 14px;
      color: var(--color-gray-900);
    }

    .session-restore-actions {
      display: flex;
      gap: var(--space-2);
    }

    /* Responsive */
    @media (max-width: 640px) {
      .container {
        padding: var(--space-4) var(--space-3);
      }

      .header h1 {
        font-size: 24px;
      }

      .header p {
        font-size: 14px;
      }

      .header {
        margin-bottom: var(--space-4);
      }

      .mode-switcher {
        width: 100%;
      }

      .mode-btn {
        flex: 1;
        padding: var(--space-3) var(--space-2);
        font-size: 13px;
      }

      .action-group {
        flex-direction: column;
      }

      .btn {
        width: 100%;
      }

      .result-value {
        font-size: 28px;
      }

      .param-card {
        padding: var(--space-4);
      }

      .input-method-selector {
        flex-direction: column;
      }

      .batch-form-container {
        padding: var(--space-4);
      }

      .batch-form-header {
        flex-direction: column;
        align-items: flex-start;
        gap: var(--space-3);
      }

      .export-actions {
        flex-direction: column;
      }

      /* Hide table, show card input on mobile */
      .batch-table-wrapper {
        display: none;
      }

      .batch-input-cards {
        display: block;
      }

      .batch-input-card {
        background: var(--color-gray-50);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin-bottom: var(--space-3);
      }

      .batch-input-card-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: var(--space-3);
      }

      .batch-input-card-number {
        font-weight: 600;
        color: var(--color-gray-700);
        font-size: 13px;
      }

      .batch-input-card-delete {
        background: transparent;
        border: none;
        color: var(--color-gray-400);
        cursor: pointer;
        padding: var(--space-2);
        border-radius: var(--radius-sm);
        font-size: 18px;
      }

      .batch-input-card-delete:hover {
        color: var(--color-error);
        background: var(--color-error-light);
      }

      .batch-input-card-fields {
        display: flex;
        flex-direction: column;
        gap: var(--space-3);
      }

      .batch-input-card-row {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-3);
      }

      .batch-input-card-field {
        display: flex;
        flex-direction: column;
        gap: 4px;
      }

      .batch-input-card-field.full-width {
        grid-column: span 2;
      }

      .batch-input-card-field label {
        font-size: 11px;
        font-weight: 600;
        color: var(--color-gray-400);
        text-transform: uppercase;
        letter-spacing: 0.03em;
        margin-bottom: 0;
      }

      .batch-input-card-field input,
      .batch-input-card-field select {
        height: 40px;
        font-size: 14px;
      }

      .batch-form-actions {
        flex-direction: column;
        width: 100%;
      }

      .batch-form-actions .btn {
        width: 100%;
      }

      /* Card view for batch results on mobile */
      .batch-results-cards {
        display: block;
      }

      .results-table-wrapper {
        display: none;
      }

      .result-card-mobile {
        background: var(--bg-surface);
        border: 1px solid var(--color-gray-200);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        margin-bottom: var(--space-3);
      }

      .result-card-mobile.error {
        background: #FEF2F2;
        border-color: var(--color-error);
      }

      .result-card-mobile-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: var(--space-3);
      }

      .result-card-mobile-id {
        font-weight: 600;
        color: var(--color-gray-900);
      }

      .result-card-mobile-line {
        font-size: 13px;
        color: var(--color-gray-500);
      }

      .result-card-mobile-force {
        font-size: 24px;
        font-weight: 700;
        color: var(--color-gray-900);
        margin: var(--space-3) 0;
      }

      .result-card-mobile-params {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: var(--space-2);
        font-size: 12px;
        color: var(--color-gray-700);
      }
    }

    @media (min-width: 641px) {
      .batch-results-cards {
        display: none;
      }
    }

    @media (min-width: 641px) and (max-width: 1023px) {
      .result-value {
        font-size: 32px;
      }

      .header {
        margin-bottom: var(--space-6);
      }
    }

    /* Tables responsive */
    @media (max-width: 640px) {
      table {
        font-size: 12px;
      }

      th, td {
        padding: var(--space-2);
      }

      .table-container {
        overflow-x: auto;
      }
    }

    /* Loading State */
    .btn-loading {
      position: relative;
      color: transparent;
    }

    .btn-loading::after {
      content: '';
      position: absolute;
      width: 16px;
      height: 16px;
      top: 50%;
      left: 50%;
      margin-left: -8px;
      margin-top: -8px;
      border: 2px solid white;
      border-radius: 50%;
      border-top-color: transparent;
      animation: spinner 0.6s linear infinite;
    }

    @keyframes spinner {
      to { transform: rotate(360deg); }
    }

    /* ======================= */
    /* V2.0 - NEW STYLES      */
    /* ======================= */

    /* Warning Banner - Method Limitations */
    .method-warning {
      background: linear-gradient(135deg, #FFFBEB 0%, #FEF3C7 100%);
      border-left: 4px solid var(--color-warning);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-top: var(--space-4);
      font-size: 13px;
      color: var(--color-gray-700);
      line-height: 1.6;
    }

    .method-warning strong {
      color: var(--color-gray-900);
      display: block;
      margin-bottom: var(--space-1);
    }

    /* P1 Calculator Panel */
    .p1-calculator-toggle {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      color: var(--color-primary);
      cursor: pointer;
      border: none;
      background: none;
      padding: 2px 0;
      font-family: var(--font-sans);
      font-weight: 500;
      transition: color var(--transition-fast);
    }

    .p1-calculator-toggle:hover {
      color: var(--color-primary-dark);
      text-decoration: underline;
    }

    .p1-calculator-toggle svg {
      width: 14px;
      height: 14px;
      transition: transform var(--transition-fast);
    }

    .p1-calculator-toggle.open svg {
      transform: rotate(180deg);
    }

    .p1-calculator-panel {
      display: none;
      background: var(--color-gray-50);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      margin-top: var(--space-3);
      animation: fadeIn 0.2s ease;
    }

    .p1-calculator-panel.show {
      display: block;
    }

    .p1-calculator-panel h5 {
      font-size: 13px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-3);
    }

    .p1-calc-fields {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: var(--space-3);
      margin-bottom: var(--space-3);
    }

    .p1-calc-field label {
      font-size: 11px;
      font-weight: 600;
      color: var(--color-gray-500);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .p1-calc-field input {
      height: 36px;
      font-size: 13px;
    }

    .p1-calc-result {
      background: var(--color-primary-light);
      border: 1px solid var(--color-primary-lighter);
      border-radius: var(--radius-sm);
      padding: var(--space-2) var(--space-3);
      font-size: 13px;
      color: var(--color-primary-darker);
      display: none;
    }

    .p1-calc-result.show {
      display: block;
    }

    .p1-calc-formula {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--color-gray-500);
      margin-bottom: var(--space-2);
    }

    @media (max-width: 640px) {
      .p1-calc-fields {
        grid-template-columns: 1fr;
      }
    }

    /* Load Example Button */
    .btn-example {
      background: var(--color-primary-light);
      color: var(--color-primary-darker);
      border: 1px solid var(--color-primary-lighter);
    }

    .btn-example:hover {
      background: var(--color-primary-lighter);
    }

    /* Force Configuration Panel */
    .config-panel {
      background: var(--bg-surface);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-xl);
      padding: var(--space-6);
      margin-top: var(--space-6);
      box-shadow: var(--shadow-md);
    }

    .config-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
      user-select: none;
    }

    .config-panel-header h3 {
      font-size: 18px;
      font-weight: 600;
      color: var(--color-gray-900);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .config-panel-toggle {
      background: none;
      border: none;
      color: var(--color-gray-400);
      cursor: pointer;
      padding: var(--space-2);
      transition: transform var(--transition-fast);
    }

    .config-panel-toggle.open {
      transform: rotate(180deg);
    }

    .config-panel-body {
      display: none;
      margin-top: var(--space-6);
      padding-top: var(--space-4);
      border-top: 1px solid var(--color-gray-100);
    }

    .config-panel-body.show {
      display: block;
    }

    .config-section {
      margin-bottom: var(--space-6);
    }

    .config-section:last-child {
      margin-bottom: 0;
    }

    .config-section h4 {
      font-size: 14px;
      font-weight: 600;
      color: var(--color-gray-800);
      margin-bottom: var(--space-3);
    }

    /* Discharge Configuration Selector */
    .config-options {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: var(--space-3);
    }

    @media (max-width: 768px) {
      .config-options {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 480px) {
      .config-options {
        grid-template-columns: 1fr;
      }
    }

    .config-option {
      border: 2px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      cursor: pointer;
      text-align: center;
      transition: all var(--transition-fast);
      background: var(--bg-surface);
    }

    .config-option:hover {
      border-color: var(--color-gray-300);
      background: var(--color-gray-50);
    }

    .config-option.active {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
    }

    .config-option input[type="radio"] {
      display: none;
    }

    .config-option-svg {
      width: 80px;
      height: 80px;
      margin: 0 auto var(--space-2);
    }

    .config-option-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--color-gray-700);
      line-height: 1.3;
    }

    .config-option.active .config-option-label {
      color: var(--color-primary-darker);
    }

    /* DLF Selection */
    .dlf-section-header {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-bottom: var(--space-3);
    }

    .dlf-section-header h4 {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }

    .dlf-section-badge {
      font-size: 10px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: var(--radius-full);
      background: var(--color-primary-lighter);
      color: var(--color-primary-darker);
      text-transform: uppercase;
      letter-spacing: 0.03em;
    }

    .dlf-options {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: var(--space-3);
      margin-bottom: var(--space-3);
    }

    .dlf-option {
      border: 2px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-3) var(--space-2);
      cursor: pointer;
      text-align: center;
      transition: all var(--transition-fast);
      background: var(--bg-surface);
      position: relative;
    }

    .dlf-option:hover {
      border-color: var(--color-gray-300);
      background: var(--color-gray-50);
    }

    .dlf-option.active {
      border-color: var(--color-primary);
      background: var(--color-primary-light);
    }

    .dlf-option.active::after {
      content: '';
      position: absolute;
      top: 6px;
      right: 6px;
      width: 8px;
      height: 8px;
      background: var(--color-primary);
      border-radius: 50%;
    }

    .dlf-option input[type="radio"] {
      display: none;
    }

    .dlf-option-value {
      font-size: 22px;
      font-weight: 700;
      color: var(--color-gray-900);
      line-height: 1.2;
    }

    .dlf-option.active .dlf-option-value {
      color: var(--color-primary-darker);
    }

    .dlf-option-label {
      font-size: 11px;
      color: var(--color-gray-500);
      margin-top: 4px;
      line-height: 1.3;
    }

    .dlf-custom-input {
      display: none;
      margin-top: var(--space-3);
      padding: var(--space-3);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
    }

    .dlf-custom-input.show {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    .dlf-custom-input label {
      margin-bottom: 0;
      white-space: nowrap;
    }

    .dlf-custom-input input {
      width: 100px;
      height: 36px;
      font-size: 14px;
      text-align: center;
    }

    .dlf-warning {
      font-size: 12px;
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-sm);
      margin-top: var(--space-2);
      display: none;
    }

    .dlf-warning.show {
      display: block;
    }

    .dlf-warning.warning-low {
      background: var(--color-warning-light);
      color: var(--color-warning);
    }

    .dlf-warning.warning-high {
      background: var(--color-error-light);
      color: var(--color-error);
    }

    .dlf-tooltip {
      font-size: 11px;
      color: var(--color-gray-400);
      margin-top: var(--space-3);
      padding-top: var(--space-2);
      border-top: 1px solid var(--color-gray-100);
      line-height: 1.5;
    }

    /* Enriched Results - Design Force */
    .design-force-section {
      margin-top: var(--space-6);
      padding-top: var(--space-4);
      border-top: 2px solid var(--color-primary-lighter);
    }

    .design-force-header {
      font-size: 16px;
      font-weight: 600;
      color: var(--color-gray-900);
      margin-bottom: var(--space-4);
    }

    .force-components-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: var(--space-3);
      margin-bottom: var(--space-4);
    }

    @media (max-width: 640px) {
      .force-components-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    .force-component {
      background: var(--color-gray-50);
      border: 1px solid var(--color-gray-200);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      text-align: center;
    }

    .force-component.highlight {
      background: var(--color-primary-light);
      border-color: var(--color-primary-lighter);
    }

    .force-component-label {
      font-size: 11px;
      font-weight: 600;
      color: var(--color-gray-500);
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .force-component-value {
      font-size: 20px;
      font-weight: 700;
      color: var(--color-gray-900);
      font-variant-numeric: tabular-nums;
    }

    .force-component.highlight .force-component-value {
      color: var(--color-primary-darker);
    }

    .force-component-unit {
      font-size: 12px;
      color: var(--color-gray-500);
    }

    /* SVG Diagram in results */
    .force-diagram {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      background: var(--color-gray-50);
      border-radius: var(--radius-md);
      margin-top: var(--space-4);
    }

    .force-diagram svg {
      max-width: 300px;
      width: 100%;
      height: auto;
    }

    /* Print Styles */
    @media print {
      body {
        background: white;
      }

      .mode-switcher,
      .action-group,
      .reference-section,
      .input-method-selector,
      .batch-form-actions,
      .export-actions,
      .session-restore-banner {
        display: none !important;
      }

      .result-card,
      .batch-form-container {
        box-shadow: none;
        border: 1px solid var(--color-gray-300);
        page-break-inside: avoid;
      }
    }
  </style>
</head>
<body>
  <div class="container" id="appContainer">
    <!-- Header -->
    <div class="header">
      <h1>PSV Reaction Force Calculator</h1>
      <p>Calcul de la force de reaction d'une soupape de surete selon F = Kf x A x P1</p>
    </div>

    <!-- Mode Switcher -->
    <div class="mode-switcher">
      <button class="mode-btn active" data-mode="simple" id="modeSimpleBtn">Calcul Simple</button>
      <button class="mode-btn" data-mode="batch" id="modeBatchBtn">Calcul Batch</button>
    </div>

    <!-- ==================== -->
    <!-- SIMPLE MODE SECTION  -->
    <!-- ==================== -->
    <div class="simple-section" id="simpleSection">
      <!-- Main Layout -->
      <div class="calc-layout">
        <!-- Left Column: Input Parameters -->
        <div class="input-section">
          <div class="param-card">
            <h4>Parametres de la soupape</h4>

            <div class="param-group">
              <label for="dn">DN (Diametre Nominal) <span class="required">*</span></label>
              <select id="dn" required>
                <option value="">Selectionner...</option>
                <option value="50">DN 50 (2")</option>
                <option value="65">DN 65 (2"1/2)</option>
                <option value="80">DN 80 (3")</option>
                <option value="100">DN 100 (4")</option>
                <option value="150">DN 150 (6")</option>
                <option value="200">DN 200 (8")</option>
                <option value=">200">DN > 200 (> 8")</option>
              </select>
              <span class="helper-text">Diametre nominal de sortie de la soupape</span>
            </div>

            <div class="param-group">
              <label for="fluidType">Type de fluide <span class="required">*</span></label>
              <select id="fluidType" required>
                <option value="">Selectionner...</option>
                <option value="gaz">Gaz</option>
                <option value="vapeur eau">Vapeur d'eau</option>
              </select>
              <span class="helper-text">Nature du fluide de process</span>
            </div>

            <div class="param-group">
              <label for="orifice">Orifice <span class="required">*</span></label>
              <select id="orifice" required>
                <option value="">Selectionner...</option>
                <option value="D">D (0,71 cm2)</option>
                <option value="E">E (1,26 cm2)</option>
                <option value="F">F (1,98 cm2)</option>
                <option value="G">G (3,24 cm2)</option>
                <option value="H">H (5,06 cm2)</option>
                <option value="J">J (8,3 cm2)</option>
                <option value="K">K (11,86 cm2)</option>
                <option value="L">L (18,41 cm2)</option>
                <option value="M">M (23,2 cm2)</option>
                <option value="N">N (28 cm2)</option>
                <option value="P">P (41,2 cm2)</option>
                <option value="Q">Q (71,2 cm2)</option>
                <option value="R">R (103 cm2)</option>
                <option value="T">T (168 cm2)</option>
                <option value="V">V (271 cm2)</option>
                <option value="W">W (406 cm2)</option>
              </select>
              <span class="helper-text">Lettre de l'orifice selon ASME</span>
            </div>

            <div class="param-group">
              <label for="pressure">Pression de decharge <span class="required">*</span></label>
              <div class="input-with-unit">
                <input type="number" id="pressure" min="0" step="0.1" placeholder="ex: 15.5" required>
                <select class="unit-select" id="pressureUnit">
                  <option value="bar">bar abs</option>
                </select>
              </div>
              <span class="helper-text">P1 = P_tarage x (1 + surpression%) + P_atm</span>
              <button type="button" class="p1-calculator-toggle" id="p1CalcToggle">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
                Calculer P1
              </button>

              <!-- P1 Calculator Panel -->
              <div class="p1-calculator-panel" id="p1CalcPanel">
                <h5>Calculateur de P1</h5>
                <div class="p1-calc-formula">P1 = P_tarage x (1 + surpression/100) + P_atm</div>
                <div class="p1-calc-fields">
                  <div class="p1-calc-field">
                    <label for="p1Ptarage">P_tarage (barg)</label>
                    <input type="number" id="p1Ptarage" min="0" step="0.1" placeholder="ex: 14.0">
                  </div>
                  <div class="p1-calc-field">
                    <label for="p1Surpression">Surpression (%)</label>
                    <input type="number" id="p1Surpression" min="0" max="100" step="1" value="10" placeholder="10">
                  </div>
                  <div class="p1-calc-field">
                    <label for="p1Patm">P_atm (bar abs)</label>
                    <input type="number" id="p1Patm" min="0.8" max="1.1" step="0.001" value="1.013" placeholder="1.013">
                  </div>
                </div>
                <button type="button" class="btn btn-small btn-success" id="p1CalcApplyBtn">Appliquer</button>
                <div class="p1-calc-result" id="p1CalcResult"></div>
              </div>
            </div>

            <!-- Method Limitation Warning -->
            <div class="method-warning">
              <strong>Methode simplifiee (Kf)</strong>
              Resultats conservatifs pour pre-dimensionnement. Pour les cas critiques (H2, &gt;100 bar, diphasique), appliquer l'API 520 Part II.
            </div>
          </div>

          <!-- Formula Box -->
          <div class="formula-box">
            <h5>Formule de calcul</h5>
            <div class="formula">F = Kf x A x P1</div>
            <div class="formula-legend">
              <strong>Kf :</strong> Facteur dependant du fluide et du DN<br>
              <strong>A :</strong> Section d'orifice de la soupape (cm2)<br>
              <strong>P1 :</strong> Pression de decharge absolue (bar)<br>
              <strong>F :</strong> Force de reaction (daN)
            </div>
          </div>

          <!-- Action Buttons -->
          <div class="action-group">
            <button class="btn btn-primary btn-large" id="calculateBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="4" y="2" width="16" height="20" rx="2"/>
                <line x1="8" y1="6" x2="16" y2="6"/>
                <line x1="8" y1="10" x2="16" y2="10"/>
                <line x1="8" y1="14" x2="16" y2="14"/>
                <line x1="8" y1="18" x2="10" y2="18"/>
              </svg>
              Calculer
            </button>
            <button class="btn btn-secondary" id="resetBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
                <path d="M3 3v5h5"/>
              </svg>
              Reinitialiser
            </button>
            <button class="btn btn-example" id="loadExampleBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
              </svg>
              Charger un exemple
            </button>
          </div>
        </div>

        <!-- Right Column: Results -->
        <div class="results-section" id="resultsSection">
          <div class="result-card">
            <h3>Resultats du calcul</h3>

            <div class="result-item">
              <span class="result-label">Force brute de reaction (F = Kf x A x P1)</span>
              <div class="result-value-group">
                <span class="result-value" id="forceValue">-</span>
                <span class="result-unit">daN</span>
              </div>
              <span class="badge badge-success" id="statusBadge">Calcule</span>
            </div>

            <div class="result-item">
              <span class="result-label">Parametres utilises</span>
              <div style="font-size: 13px; color: var(--color-gray-700); line-height: 1.8;">
                <div id="paramsSummary"></div>
              </div>
            </div>
          </div>

          <!-- Force Application Configuration Panel -->
          <div class="config-panel" id="configPanel">
            <div class="config-panel-header" id="configPanelHeader">
              <h3>
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="3"/>
                  <path d="M12 1v6m0 6v6m11-7h-6m-6 0H1m15.5-7.8l-4.2 4.2M6.7 17.3l4.2-4.2m0-6.2l4.2 4.2M6.7 6.7l4.2 4.2"/>
                </svg>
                Configuration d'application des forces
              </h3>
              <button class="config-panel-toggle" id="configPanelToggle">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <polyline points="6 9 12 15 18 9"/>
                </svg>
              </button>
            </div>

            <div class="config-panel-body" id="configPanelBody">
              <!-- Section 1: Discharge Configuration -->
              <div class="config-section">
                <h4>Type de configuration de decharge</h4>
                <div class="config-options" id="configOptions">
                  <!-- CFG-1: Vertical Up (Isometric) -->
                  <label class="config-option active" data-config="CFG-1">
                    <input type="radio" name="dischargeConfig" value="CFG-1" checked>
                    <div class="config-option-svg">
                      <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                          <marker id="arrowBlue" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#3B82F6"/></marker>
                          <marker id="arrowRed" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#EF4444"/></marker>
                        </defs>
                        <!-- Pipe base isometric -->
                        <ellipse cx="40" cy="58" rx="12" ry="5" fill="#E5E7EB" stroke="#6B7280" stroke-width="1.2"/>
                        <rect x="28" y="42" width="24" height="16" fill="#E5E7EB" stroke="none"/>
                        <line x1="28" y1="42" x2="28" y2="58" stroke="#6B7280" stroke-width="1.2"/>
                        <line x1="52" y1="42" x2="52" y2="58" stroke="#6B7280" stroke-width="1.2"/>
                        <ellipse cx="40" cy="42" rx="12" ry="5" fill="#D1D5DB" stroke="#6B7280" stroke-width="1.2"/>
                        <!-- Valve body -->
                        <rect x="34" y="30" width="12" height="14" fill="#D1D5DB" stroke="#6B7280" stroke-width="1.2" rx="1"/>
                        <ellipse cx="40" cy="30" rx="6" ry="2.5" fill="#C0C7CF" stroke="#6B7280" stroke-width="1"/>
                        <!-- Discharge up -->
                        <line x1="40" y1="28" x2="40" y2="10" stroke="#3B82F6" stroke-width="2" marker-end="url(#arrowBlue)"/>
                        <text x="48" y="14" font-size="6.5" fill="#3B82F6" font-weight="600">Sortie</text>
                        <!-- Reaction force down -->
                        <line x1="40" y1="63" x2="40" y2="76" stroke="#EF4444" stroke-width="2.5" marker-end="url(#arrowRed)"/>
                        <text x="48" y="74" font-size="6.5" fill="#EF4444" font-weight="600">F</text>
                      </svg>
                    </div>
                    <div class="config-option-label">Verticale haut</div>
                  </label>

                  <!-- CFG-2: Vertical Down (Isometric) -->
                  <label class="config-option" data-config="CFG-2">
                    <input type="radio" name="dischargeConfig" value="CFG-2">
                    <div class="config-option-svg">
                      <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                          <marker id="arrowBlue2" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#3B82F6"/></marker>
                          <marker id="arrowRed2" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#EF4444"/></marker>
                        </defs>
                        <!-- Reaction force up -->
                        <line x1="40" y1="17" x2="40" y2="4" stroke="#EF4444" stroke-width="2.5" marker-end="url(#arrowRed2)"/>
                        <text x="48" y="8" font-size="6.5" fill="#EF4444" font-weight="600">F</text>
                        <!-- Pipe base isometric -->
                        <ellipse cx="40" cy="24" rx="12" ry="5" fill="#D1D5DB" stroke="#6B7280" stroke-width="1.2"/>
                        <rect x="28" y="24" width="24" height="16" fill="#E5E7EB" stroke="none"/>
                        <line x1="28" y1="24" x2="28" y2="40" stroke="#6B7280" stroke-width="1.2"/>
                        <line x1="52" y1="24" x2="52" y2="40" stroke="#6B7280" stroke-width="1.2"/>
                        <ellipse cx="40" cy="40" rx="12" ry="5" fill="#E5E7EB" stroke="#6B7280" stroke-width="1.2"/>
                        <!-- Valve nozzle down -->
                        <rect x="34" y="40" width="12" height="14" fill="#D1D5DB" stroke="#6B7280" stroke-width="1.2" rx="1"/>
                        <ellipse cx="40" cy="54" rx="6" ry="2.5" fill="#C0C7CF" stroke="#6B7280" stroke-width="1"/>
                        <!-- Discharge down -->
                        <line x1="40" y1="56" x2="40" y2="74" stroke="#3B82F6" stroke-width="2" marker-end="url(#arrowBlue2)"/>
                        <text x="48" y="72" font-size="6.5" fill="#3B82F6" font-weight="600">Sortie</text>
                      </svg>
                    </div>
                    <div class="config-option-label">Verticale bas</div>
                  </label>

                  <!-- CFG-3: Horizontal (Isometric) -->
                  <label class="config-option" data-config="CFG-3">
                    <input type="radio" name="dischargeConfig" value="CFG-3">
                    <div class="config-option-svg">
                      <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                          <marker id="arrowBlue3" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#3B82F6"/></marker>
                          <marker id="arrowRed3" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#EF4444"/></marker>
                        </defs>
                        <!-- Horizontal pipe body (isometric cylinder lying on side) -->
                        <ellipse cx="18" cy="40" rx="5" ry="12" fill="#E5E7EB" stroke="#6B7280" stroke-width="1.2"/>
                        <rect x="18" y="28" width="22" height="24" fill="#E5E7EB" stroke="none"/>
                        <line x1="18" y1="28" x2="40" y2="28" stroke="#6B7280" stroke-width="1.2"/>
                        <line x1="18" y1="52" x2="40" y2="52" stroke="#6B7280" stroke-width="1.2"/>
                        <ellipse cx="40" cy="40" rx="5" ry="12" fill="#D1D5DB" stroke="#6B7280" stroke-width="1.2"/>
                        <!-- Nozzle -->
                        <rect x="40" y="34" width="10" height="12" fill="#D1D5DB" stroke="#6B7280" stroke-width="1.2" rx="1"/>
                        <!-- Discharge right -->
                        <line x1="52" y1="40" x2="70" y2="40" stroke="#3B82F6" stroke-width="2" marker-end="url(#arrowBlue3)"/>
                        <text x="60" y="36" font-size="6.5" fill="#3B82F6" font-weight="600">Sortie</text>
                        <!-- Reaction force left -->
                        <line x1="13" y1="40" x2="3" y2="40" stroke="#EF4444" stroke-width="2.5" marker-end="url(#arrowRed3)"/>
                        <text x="2" y="50" font-size="6.5" fill="#EF4444" font-weight="600">F</text>
                      </svg>
                    </div>
                    <div class="config-option-label">Horizontale</div>
                  </label>

                  <!-- CFG-4: 90 Elbow (Isometric) -->
                  <label class="config-option" data-config="CFG-4">
                    <input type="radio" name="dischargeConfig" value="CFG-4">
                    <div class="config-option-svg">
                      <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                          <marker id="arrowBlue4" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#3B82F6"/></marker>
                          <marker id="arrowRed4a" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#EF4444"/></marker>
                          <marker id="arrowRed4b" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#EF4444"/></marker>
                        </defs>
                        <!-- Valve body isometric -->
                        <ellipse cx="28" cy="56" rx="10" ry="4" fill="#E5E7EB" stroke="#6B7280" stroke-width="1"/>
                        <rect x="18" y="42" width="20" height="14" fill="#E5E7EB" stroke="none"/>
                        <line x1="18" y1="42" x2="18" y2="56" stroke="#6B7280" stroke-width="1"/>
                        <line x1="38" y1="42" x2="38" y2="56" stroke="#6B7280" stroke-width="1"/>
                        <ellipse cx="28" cy="42" rx="10" ry="4" fill="#D1D5DB" stroke="#6B7280" stroke-width="1"/>
                        <!-- Elbow pipe going up then right -->
                        <path d="M28 38 L28 24 Q28 18 36 18 L50 18" stroke="#9CA3AF" stroke-width="7" fill="none" stroke-linecap="round"/>
                        <path d="M28 38 L28 24 Q28 18 36 18 L50 18" stroke="#6B7280" stroke-width="1.2" fill="none"/>
                        <!-- Discharge right -->
                        <line x1="50" y1="18" x2="68" y2="18" stroke="#3B82F6" stroke-width="2" marker-end="url(#arrowBlue4)"/>
                        <text x="58" y="14" font-size="6" fill="#3B82F6" font-weight="600">Sortie</text>
                        <!-- Reaction Fy down -->
                        <line x1="28" y1="60" x2="28" y2="74" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed4a)"/>
                        <text x="32" y="73" font-size="5.5" fill="#EF4444" font-weight="600">Fy</text>
                        <!-- Reaction Fx left -->
                        <line x1="18" y1="49" x2="6" y2="49" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed4b)"/>
                        <text x="3" y="46" font-size="5.5" fill="#EF4444" font-weight="600">Fx</text>
                      </svg>
                    </div>
                    <div class="config-option-label">Coude 90</div>
                  </label>

                  <!-- CFG-5: Collector/Flare (Isometric) -->
                  <label class="config-option" data-config="CFG-5">
                    <input type="radio" name="dischargeConfig" value="CFG-5">
                    <div class="config-option-svg">
                      <svg viewBox="0 0 80 80" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <defs>
                          <marker id="arrowRed5" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#EF4444"/></marker>
                        </defs>
                        <!-- Valve body isometric (small, left) -->
                        <ellipse cx="16" cy="44" rx="7" ry="3" fill="#E5E7EB" stroke="#6B7280" stroke-width="1"/>
                        <rect x="9" y="34" width="14" height="10" fill="#E5E7EB" stroke="none"/>
                        <line x1="9" y1="34" x2="9" y2="44" stroke="#6B7280" stroke-width="1"/>
                        <line x1="23" y1="34" x2="23" y2="44" stroke="#6B7280" stroke-width="1"/>
                        <ellipse cx="16" cy="34" rx="7" ry="3" fill="#D1D5DB" stroke="#6B7280" stroke-width="1"/>
                        <!-- Nozzle to collector -->
                        <rect x="23" y="36" width="6" height="8" fill="#D1D5DB" stroke="#6B7280" stroke-width="1" rx="0.5"/>
                        <!-- Collector (large pipe isometric) -->
                        <ellipse cx="48" cy="39" rx="6" ry="18" fill="#F3F4F6" stroke="#6B7280" stroke-width="1.2" stroke-dasharray="3 2"/>
                        <rect x="48" y="21" width="20" height="36" fill="#F3F4F6" stroke="none"/>
                        <line x1="48" y1="21" x2="68" y2="21" stroke="#6B7280" stroke-width="1.2" stroke-dasharray="3 2"/>
                        <line x1="48" y1="57" x2="68" y2="57" stroke="#6B7280" stroke-width="1.2" stroke-dasharray="3 2"/>
                        <ellipse cx="68" cy="39" rx="6" ry="18" fill="#F3F4F6" stroke="#6B7280" stroke-width="1.2" stroke-dasharray="3 2"/>
                        <text x="58" y="41" text-anchor="middle" font-size="6" fill="#6B7280">Coll.</text>
                        <!-- Reaction force left (reduced) -->
                        <line x1="9" y1="39" x2="2" y2="39" stroke="#EF4444" stroke-width="2" marker-end="url(#arrowRed5)"/>
                        <text x="1" y="50" font-size="5" fill="#EF4444" font-weight="600">F (red.)</text>
                      </svg>
                    </div>
                    <div class="config-option-label">Collecteur (torche)</div>
                  </label>
                </div>
              </div>

              <!-- Section 2: Dynamic Load Factor -->
              <div class="config-section">
                <div class="dlf-section-header">
                  <h4>Facteur de charge dynamique</h4>
                  <span class="dlf-section-badge">DLF</span>
                </div>
                <div class="dlf-options" id="dlfOptions">
                  <label class="dlf-option active" data-dlf="conservative">
                    <input type="radio" name="dlfMode" value="conservative" checked>
                    <div class="dlf-option-value">2.0</div>
                    <div class="dlf-option-label">Conservatif</div>
                  </label>
                  <label class="dlf-option" data-dlf="static">
                    <input type="radio" name="dlfMode" value="static">
                    <div class="dlf-option-value">1.0</div>
                    <div class="dlf-option-label">Statique eq.</div>
                  </label>
                  <label class="dlf-option" data-dlf="custom">
                    <input type="radio" name="dlfMode" value="custom">
                    <div class="dlf-option-value">?</div>
                    <div class="dlf-option-label">Personnalise</div>
                  </label>
                </div>
                <div class="dlf-custom-input" id="dlfCustomInput">
                  <label for="dlfCustomValue">Valeur :</label>
                  <input type="number" id="dlfCustomValue" min="0.5" max="5.0" step="0.1" placeholder="2.0">
                </div>
                <div class="dlf-warning" id="dlfWarning"></div>
                <div class="dlf-tooltip">Amplifie la force brute pour tenir compte de l'ouverture dynamique de la soupape. Valeur par defaut : 2.0</div>
              </div>

              <!-- Section 3: Enriched Results -->
              <div class="config-section">
                <div class="design-force-header">Force de design et composantes directionnelles</div>
                <!-- Coordinate Triad -->
                <div style="display: flex; align-items: center; gap: var(--space-3); margin-bottom: var(--space-4); padding: var(--space-3); background: var(--color-gray-50); border-radius: var(--radius-md); border: 1px solid var(--color-gray-200);">
                  <svg viewBox="0 0 70 70" width="60" height="60" xmlns="http://www.w3.org/2000/svg">
                    <defs>
                      <marker id="triadArrowX" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#EF4444"/></marker>
                      <marker id="triadArrowY" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#22C55E"/></marker>
                      <marker id="triadArrowZ" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto"><path d="M0,0 L6,3 L0,6 Z" fill="#3B82F6"/></marker>
                    </defs>
                    <!-- Origin point -->
                    <circle cx="25" cy="45" r="2.5" fill="#374151"/>
                    <!-- X axis (right) -->
                    <line x1="25" y1="45" x2="60" y2="45" stroke="#EF4444" stroke-width="2" marker-end="url(#triadArrowX)"/>
                    <text x="63" y="49" font-size="10" fill="#EF4444" font-weight="700">X</text>
                    <!-- Y axis (up) -->
                    <line x1="25" y1="45" x2="25" y2="10" stroke="#22C55E" stroke-width="2" marker-end="url(#triadArrowY)"/>
                    <text x="21" y="8" font-size="10" fill="#22C55E" font-weight="700">Y</text>
                    <!-- Z axis (isometric out towards viewer) -->
                    <line x1="25" y1="45" x2="6" y2="60" stroke="#3B82F6" stroke-width="2" marker-end="url(#triadArrowZ)"/>
                    <text x="1" y="68" font-size="10" fill="#3B82F6" font-weight="700">Z</text>
                  </svg>
                  <div style="font-size: 12px; color: var(--color-gray-600); line-height: 1.6;">
                    <div><strong style="color: #EF4444;">X</strong> : Horizontal (axe de la tuyauterie)</div>
                    <div><strong style="color: #22C55E;">Y</strong> : Vertical (haut positif)</div>
                    <div><strong style="color: #3B82F6;">Z</strong> : Lateral</div>
                  </div>
                </div>
                <div class="force-components-grid" id="forceComponentsGrid">
                  <div class="force-component highlight">
                    <div class="force-component-label">F_design</div>
                    <div class="force-component-value" id="fDesignValue">-</div>
                    <div class="force-component-unit">daN</div>
                  </div>
                  <div class="force-component">
                    <div class="force-component-label">Fx</div>
                    <div class="force-component-value" id="fxValue">-</div>
                    <div class="force-component-unit">daN</div>
                  </div>
                  <div class="force-component">
                    <div class="force-component-label">Fy</div>
                    <div class="force-component-value" id="fyValue">-</div>
                    <div class="force-component-unit">daN</div>
                  </div>
                  <div class="force-component">
                    <div class="force-component-label">Fz</div>
                    <div class="force-component-value" id="fzValue">-</div>
                    <div class="force-component-unit">daN</div>
                  </div>
                </div>
                <div class="force-diagram" id="forceDiagram">
                  <!-- SVG diagram will be inserted by JavaScript based on selected config -->
                </div>
              </div>
            </div>
          </div>

          <div class="action-group">
            <button class="btn btn-secondary" id="copyBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              Copier le resultat
            </button>
            <button class="btn btn-secondary" id="printBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <polyline points="6 9 6 2 18 2 18 9"/>
                <path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/>
                <rect x="6" y="14" width="12" height="8"/>
              </svg>
              Imprimer / PDF
            </button>
          </div>
        </div>
      </div>

      <!-- Reference Tables -->
      <div class="reference-section">
        <h3>Tables de reference</h3>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>DN (mm)</th>
                <th>Taille (pouces)</th>
                <th>Kf Gaz</th>
                <th>Kf Vapeur d'eau</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>50</td><td>2"</td><td>1,9</td><td>2,0</td></tr>
              <tr><td>65</td><td>2"1/2</td><td>1,9</td><td>2,0</td></tr>
              <tr><td>80</td><td>3"</td><td>1,5</td><td>1,6</td></tr>
              <tr><td>100</td><td>4"</td><td>1,5</td><td>1,6</td></tr>
              <tr><td>150</td><td>6"</td><td>1,3</td><td>1,3</td></tr>
              <tr><td>200</td><td>8"</td><td>1,1</td><td>1,1</td></tr>
              <tr><td>> 200</td><td>> 8"</td><td>1,1</td><td>1,1</td></tr>
            </tbody>
          </table>
        </div>

        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Orifice</th>
                <th>Section (cm2)</th>
                <th>Orifice</th>
                <th>Section (cm2)</th>
              </tr>
            </thead>
            <tbody>
              <tr><td>D</td><td>0,71</td><td>K</td><td>11,86</td></tr>
              <tr><td>E</td><td>1,26</td><td>L</td><td>18,41</td></tr>
              <tr><td>F</td><td>1,98</td><td>M</td><td>23,2</td></tr>
              <tr><td>G</td><td>3,24</td><td>N</td><td>28</td></tr>
              <tr><td>H</td><td>5,06</td><td>P</td><td>41,2</td></tr>
              <tr><td>J</td><td>8,3</td><td>Q</td><td>71,2</td></tr>
              <tr><td></td><td></td><td>R</td><td>103</td></tr>
              <tr><td></td><td></td><td>T</td><td>168</td></tr>
              <tr><td></td><td></td><td>V</td><td>271</td></tr>
              <tr><td></td><td></td><td>W</td><td>406</td></tr>
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- ==================== -->
    <!-- BATCH MODE SECTION   -->
    <!-- ==================== -->
    <div class="batch-section" id="batchSection">
      <!-- Session Restore Banner -->
      <div class="session-restore-banner" id="sessionRestoreBanner">
        <div class="session-restore-text">
          <span>&#9888;</span>
          <span>Une session precedente a ete detectee. Voulez-vous la restaurer ?</span>
        </div>
        <div class="session-restore-actions">
          <button class="btn btn-small btn-primary" id="restoreSessionBtn">Restaurer</button>
          <button class="btn btn-small btn-secondary" id="discardSessionBtn">Ignorer</button>
        </div>
      </div>

      <!-- Input Method Selector -->
      <div class="input-method-selector">
        <label class="input-method-option active" id="methodFormOption">
          <input type="radio" name="inputMethod" value="form" checked>
          <div class="method-label">Formulaire</div>
          <div class="method-desc">Saisie manuelle multi-lignes</div>
        </label>
        <label class="input-method-option" id="methodCsvOption">
          <input type="radio" name="inputMethod" value="csv">
          <div class="method-label">Import CSV</div>
          <div class="method-desc">Importer depuis un fichier</div>
        </label>
      </div>

      <!-- Batch Form -->
      <div class="batch-form-container" id="batchFormContainer">
        <div class="batch-form-header">
          <h4>Saisie des PSV</h4>
          <div class="batch-form-actions">
            <button class="btn btn-small btn-secondary" id="addRowBtn">+ Ajouter une ligne</button>
            <button class="btn btn-small btn-secondary" id="addFiveRowsBtn">+ Ajouter 5 lignes</button>
          </div>
        </div>

        <!-- Desktop Table -->
        <div class="batch-table-wrapper">
          <table class="batch-table" id="batchTable">
            <thead>
              <tr>
                <th class="row-number">#</th>
                <th>ITEM ID *</th>
                <th>Nom de ligne *</th>
                <th>DN *</th>
                <th>Fluide *</th>
                <th>Orifice *</th>
                <th>Pression (bar abs) *</th>
                <th>Config.</th>
                <th>DLF</th>
                <th class="action-cell"></th>
              </tr>
            </thead>
            <tbody id="batchTableBody">
              <!-- Rows will be generated by JavaScript -->
            </tbody>
          </table>
        </div>

        <!-- Mobile Cards -->
        <div class="batch-input-cards" id="batchInputCards">
          <!-- Cards will be generated by JavaScript -->
        </div>

        <!-- Batch Action Buttons -->
        <div class="action-group">
          <button class="btn btn-primary btn-large" id="calculateBatchBtn" disabled>
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <rect x="4" y="2" width="16" height="20" rx="2"/>
              <line x1="8" y1="6" x2="16" y2="6"/>
              <line x1="8" y1="10" x2="16" y2="10"/>
              <line x1="8" y1="14" x2="16" y2="14"/>
              <line x1="8" y1="18" x2="10" y2="18"/>
            </svg>
            Calculer tout
          </button>
          <button class="btn btn-secondary" id="resetBatchBtn">
            <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8"/>
              <path d="M3 3v5h5"/>
            </svg>
            Reinitialiser
          </button>
        </div>
      </div>

      <!-- CSV Import Zone -->
      <div class="csv-import-zone" id="csvImportZone">
        <div class="batch-form-container">
          <div class="batch-form-header">
            <h4>Import CSV</h4>
            <button class="btn btn-small btn-secondary" id="downloadTemplateBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Telecharger le template CSV
            </button>
          </div>

          <div class="drop-zone" id="dropZone">
            <div class="drop-zone-icon">&#128196;</div>
            <div class="drop-zone-text">Glissez votre fichier CSV ici</div>
            <div class="drop-zone-hint">ou cliquez pour selectionner</div>
            <div class="drop-zone-hint" style="margin-top: 8px;">Format attendu : CSV (UTF-8) | Taille max : 5 MB</div>
            <input type="file" class="file-input" id="csvFileInput" accept=".csv">
          </div>

          <!-- CSV Preview -->
          <div class="csv-preview" id="csvPreview">
            <div class="csv-preview-header">
              <h5>Fichier analyse : <span id="csvFileName"></span></h5>
              <div class="csv-preview-stats">
                <div class="csv-preview-stat">
                  <span class="badge badge-success" id="csvValidCount">0 valides</span>
                </div>
                <div class="csv-preview-stat">
                  <span class="badge badge-warning" id="csvWarningCount">0 avertissements</span>
                </div>
                <div class="csv-preview-stat">
                  <span class="badge badge-error" id="csvErrorCount">0 erreurs</span>
                </div>
              </div>
            </div>

            <div class="csv-errors-list" id="csvErrorsList" style="display: none;"></div>

            <div class="action-group">
              <button class="btn btn-secondary" id="cancelCsvBtn">Annuler</button>
              <button class="btn btn-primary" id="importCsvBtn">Importer les lignes valides</button>
            </div>
          </div>
        </div>
      </div>

      <!-- Batch Results -->
      <div class="batch-results" id="batchResults">
        <div class="batch-form-container">
          <div class="batch-results-header">
            <h4>Resultats du calcul</h4>
            <div class="batch-results-stats">
              <span class="badge badge-success" id="resultsValidCount">0 valides</span>
              <span class="badge badge-error" id="resultsErrorCount">0 erreurs</span>
            </div>
          </div>

          <!-- Desktop Table -->
          <div class="results-table-wrapper">
            <table class="results-table" id="resultsTable">
              <thead>
                <tr>
                  <th>ITEM ID</th>
                  <th>Nom de ligne</th>
                  <th>DN</th>
                  <th>Fluide</th>
                  <th>Orifice</th>
                  <th>P1 (bar)</th>
                  <th>Kf</th>
                  <th>A (cm2)</th>
                  <th>F brute (daN)</th>
                  <th>DLF</th>
                  <th>F design (daN)</th>
                  <th>Fx</th>
                  <th>Fy</th>
                  <th>Fz</th>
                  <th>Statut</th>
                </tr>
              </thead>
              <tbody id="resultsTableBody">
                <!-- Results will be generated by JavaScript -->
              </tbody>
            </table>
          </div>

          <!-- Mobile Cards -->
          <div class="batch-results-cards" id="resultsCards">
            <!-- Cards will be generated by JavaScript -->
          </div>

          <!-- Export Actions -->
          <div class="export-actions">
            <button class="btn btn-secondary" id="exportCsvBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/>
                <polyline points="7 10 12 15 17 10"/>
                <line x1="12" y1="15" x2="12" y2="3"/>
              </svg>
              Telecharger CSV
            </button>
            <button class="btn btn-secondary" id="exportPdfBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/>
                <polyline points="14 2 14 8 20 8"/>
                <line x1="16" y1="13" x2="8" y2="13"/>
                <line x1="16" y1="17" x2="8" y2="17"/>
                <polyline points="10 9 9 9 8 9"/>
              </svg>
              Exporter PDF
            </button>
            <button class="btn btn-secondary" id="copyResultsBtn">
              <svg class="btn-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/>
              </svg>
              Copier dans presse-papier
            </button>
          </div>
        </div>
      </div>

      <!-- Formula Reference for Batch -->
      <div class="formula-box" style="margin-top: var(--space-6);">
        <h5>Formules de calcul</h5>
        <div class="formula">F_brute = Kf x A x P1 &nbsp;&nbsp;|&nbsp;&nbsp; F_design = F_brute x DLF</div>
        <div class="formula-legend">
          <strong>Kf :</strong> Facteur dependant du fluide et du DN |
          <strong>A :</strong> Section d'orifice (cm2) |
          <strong>P1 :</strong> Pression de decharge absolue (bar) |
          <strong>F_brute :</strong> Force brute de reaction (daN) |
          <strong>DLF :</strong> Dynamic Load Factor |
          <strong>F_design :</strong> Force de design (daN)
        </div>
      </div>

      <!-- Method Limitation Warning (Batch) -->
      <div class="method-warning" style="margin-top: var(--space-4);">
        <strong>Methode simplifiee</strong>
        Cette methode utilise des facteurs Kf empiriques. Pour les cas critiques (H2, haute pression &gt; 100 bar, services diphasiques, contre-pression significative), un calcul conforme a l'API 520 Part II est requis.
      </div>
    </div>
  </div>

  <!-- Toast Notification -->
  <div class="toast" id="toast">
    <span id="toastMessage"></span>
  </div>

  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
    <div class="loading-text" id="loadingText">Calcul en cours...</div>
  </div>

  <script>
    // ============================
    // DATA TABLES
    // Source de verite pour Google Sheets : config.gs
    // Toute modification des tables ci-dessous doit
    // etre repercutee dans config.gs (et inversement).
    // ============================
    const kfTable = {
      '50': { 'gaz': 1.9, 'vapeur eau': 2.0 },
      '65': { 'gaz': 1.9, 'vapeur eau': 2.0 },
      '80': { 'gaz': 1.5, 'vapeur eau': 1.6 },
      '100': { 'gaz': 1.5, 'vapeur eau': 1.6 },
      '150': { 'gaz': 1.3, 'vapeur eau': 1.3 },
      '200': { 'gaz': 1.1, 'vapeur eau': 1.1 },
      '>200': { 'gaz': 1.1, 'vapeur eau': 1.1 }
    };

    const areaTable = {
      'D': 0.71, 'E': 1.26, 'F': 1.98, 'G': 3.24, 'H': 5.06,
      'J': 8.3, 'K': 11.86, 'L': 18.41, 'M': 23.2, 'N': 28,
      'P': 41.2, 'Q': 71.2, 'R': 103, 'T': 168, 'V': 271, 'W': 406
    };

    const validDNs = ['50', '65', '80', '100', '150', '200', '>200'];
    const validFluids = ['gaz', 'vapeur eau'];
    const validOrifices = ['D', 'E', 'F', 'G', 'H', 'J', 'K', 'L', 'M', 'N', 'P', 'Q', 'R', 'T', 'V', 'W'];

    // ============================
    // V2.0 - CONFIGURATIONS TABLE
    // ============================
    const configurationsTable = {
      'CFG-1': {
        id: 'CFG-1',
        label: 'Verticale haut',
        description: 'Decharge verticale ouverte (vers le haut)',
        components: (fDesign) => ({ fx: 0, fy: -fDesign, fz: 0 })
      },
      'CFG-2': {
        id: 'CFG-2',
        label: 'Verticale bas',
        description: 'Decharge verticale ouverte (vers le bas)',
        components: (fDesign) => ({ fx: 0, fy: fDesign, fz: 0 })
      },
      'CFG-3': {
        id: 'CFG-3',
        label: 'Horizontale',
        description: 'Decharge horizontale',
        components: (fDesign) => ({ fx: -fDesign, fy: 0, fz: 0 })
      },
      'CFG-4': {
        id: 'CFG-4',
        label: 'Coude 90',
        description: 'Decharge avec coude a 90',
        components: (fDesign) => {
          const comp = fDesign / Math.sqrt(2);
          return { fx: -parseFloat(comp.toFixed(2)), fy: -parseFloat(comp.toFixed(2)), fz: 0 };
        }
      },
      'CFG-5': {
        id: 'CFG-5',
        label: 'Collecteur',
        description: 'Decharge dans collecteur (torche)',
        components: (fDesign) => ({ fx: -fDesign, fy: 0, fz: 0 })
      }
    };

    const validConfigs = ['CFG-1', 'CFG-2', 'CFG-3', 'CFG-4', 'CFG-5'];

    const dlfPresets = {
      conservative: { value: 2.0, label: 'Conservatif', description: 'Pas d\'analyse dynamique' },
      static: { value: 1.0, label: 'Statique equivalent', description: 'Cas de charge occasionnel simple' },
      custom: { value: null, label: 'Personnalise', description: 'Analyse dynamique realisee' }
    };

    // P1 helper defaults
    const p1Defaults = {
      gaz: { surpression: 10 },
      feu: { surpression: 21 }
    };

    // ============================
    // APPLICATION STATE
    // ============================
    let appState = {
      mode: 'simple',
      batchInputMethod: 'form',
      psvList: [],
      calculated: false,
      results: [],
      stats: { total: 0, valid: 0, errors: 0, empty: 0 },
      // v2.0 state
      selectedConfig: 'CFG-1',
      dlfMode: 'conservative',
      dlfValue: 2.0
    };

    // ============================
    // DOM ELEMENTS - SIMPLE MODE
    // ============================
    const dnInput = document.getElementById('dn');
    const fluidTypeInput = document.getElementById('fluidType');
    const orificeInput = document.getElementById('orifice');
    const pressureInput = document.getElementById('pressure');
    const calculateBtn = document.getElementById('calculateBtn');
    const resetBtn = document.getElementById('resetBtn');
    const copyBtn = document.getElementById('copyBtn');
    const printBtn = document.getElementById('printBtn');
    const resultsSection = document.getElementById('resultsSection');
    const forceValue = document.getElementById('forceValue');
    const paramsSummary = document.getElementById('paramsSummary');

    // ============================
    // DOM ELEMENTS - MODE SWITCHING
    // ============================
    const modeSimpleBtn = document.getElementById('modeSimpleBtn');
    const modeBatchBtn = document.getElementById('modeBatchBtn');
    const simpleSection = document.getElementById('simpleSection');
    const batchSection = document.getElementById('batchSection');
    const appContainer = document.getElementById('appContainer');

    // ============================
    // DOM ELEMENTS - BATCH MODE
    // ============================
    const methodFormOption = document.getElementById('methodFormOption');
    const methodCsvOption = document.getElementById('methodCsvOption');
    const batchFormContainer = document.getElementById('batchFormContainer');
    const csvImportZone = document.getElementById('csvImportZone');
    const batchTableBody = document.getElementById('batchTableBody');
    const batchInputCards = document.getElementById('batchInputCards');
    const addRowBtn = document.getElementById('addRowBtn');
    const addFiveRowsBtn = document.getElementById('addFiveRowsBtn');
    const calculateBatchBtn = document.getElementById('calculateBatchBtn');
    const resetBatchBtn = document.getElementById('resetBatchBtn');
    const batchResults = document.getElementById('batchResults');
    const resultsTableBody = document.getElementById('resultsTableBody');
    const resultsCards = document.getElementById('resultsCards');

    // CSV Import Elements
    const dropZone = document.getElementById('dropZone');
    const csvFileInput = document.getElementById('csvFileInput');
    const csvPreview = document.getElementById('csvPreview');
    const csvFileName = document.getElementById('csvFileName');
    const csvValidCount = document.getElementById('csvValidCount');
    const csvWarningCount = document.getElementById('csvWarningCount');
    const csvErrorCount = document.getElementById('csvErrorCount');
    const csvErrorsList = document.getElementById('csvErrorsList');
    const cancelCsvBtn = document.getElementById('cancelCsvBtn');
    const importCsvBtn = document.getElementById('importCsvBtn');
    const downloadTemplateBtn = document.getElementById('downloadTemplateBtn');

    // Export Elements
    const exportCsvBtn = document.getElementById('exportCsvBtn');
    const exportPdfBtn = document.getElementById('exportPdfBtn');
    const copyResultsBtn = document.getElementById('copyResultsBtn');

    // Session Restore Elements
    const sessionRestoreBanner = document.getElementById('sessionRestoreBanner');
    const restoreSessionBtn = document.getElementById('restoreSessionBtn');
    const discardSessionBtn = document.getElementById('discardSessionBtn');

    // V2.0 - P1 Calculator Elements
    const p1CalcToggle = document.getElementById('p1CalcToggle');
    const p1CalcPanel = document.getElementById('p1CalcPanel');
    const p1Ptarage = document.getElementById('p1Ptarage');
    const p1Surpression = document.getElementById('p1Surpression');
    const p1Patm = document.getElementById('p1Patm');
    const p1CalcApplyBtn = document.getElementById('p1CalcApplyBtn');
    const p1CalcResult = document.getElementById('p1CalcResult');

    // V2.0 - Load Example Button
    const loadExampleBtn = document.getElementById('loadExampleBtn');

    // V2.0 - Configuration Panel Elements
    const configPanel = document.getElementById('configPanel');
    const configPanelHeader = document.getElementById('configPanelHeader');
    const configPanelToggle = document.getElementById('configPanelToggle');
    const configPanelBody = document.getElementById('configPanelBody');
    const configOptions = document.getElementById('configOptions');
    const dlfOptions = document.getElementById('dlfOptions');
    const dlfCustomInput = document.getElementById('dlfCustomInput');
    const dlfCustomValue = document.getElementById('dlfCustomValue');
    const dlfWarning = document.getElementById('dlfWarning');
    const fDesignValue = document.getElementById('fDesignValue');
    const fxValue = document.getElementById('fxValue');
    const fyValue = document.getElementById('fyValue');
    const fzValue = document.getElementById('fzValue');
    const forceDiagram = document.getElementById('forceDiagram');

    // Toast & Loading
    const toast = document.getElementById('toast');
    const toastMessage = document.getElementById('toastMessage');
    const loadingOverlay = document.getElementById('loadingOverlay');
    const loadingText = document.getElementById('loadingText');

    // ============================
    // UTILITY FUNCTIONS
    // ============================
    function showToast(message, type = 'success') {
      toast.className = 'toast show ' + type;
      toastMessage.textContent = message;
      setTimeout(() => {
        toast.className = 'toast';
      }, 3000);
    }

    function showLoading(text = 'Calcul en cours...') {
      loadingText.textContent = text;
      loadingOverlay.classList.add('show');
    }

    function hideLoading() {
      loadingOverlay.classList.remove('show');
    }

    function debounce(func, wait) {
      let timeout;
      return function executedFunction(...args) {
        const later = () => {
          clearTimeout(timeout);
          func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
      };
    }

    // ============================
    // MODE SWITCHING
    // ============================
    function switchMode(mode) {
      appState.mode = mode;

      // Update URL
      const url = new URL(window.location);
      if (mode === 'batch') {
        url.searchParams.set('mode', 'batch');
      } else {
        url.searchParams.delete('mode');
      }
      window.history.replaceState({}, '', url);

      // Update UI
      modeSimpleBtn.classList.toggle('active', mode === 'simple');
      modeBatchBtn.classList.toggle('active', mode === 'batch');
      simpleSection.classList.toggle('hide', mode === 'batch');
      batchSection.classList.toggle('show', mode === 'batch');
      appContainer.classList.toggle('batch-mode', mode === 'batch');

      // Check for saved session in batch mode
      if (mode === 'batch') {
        checkSavedSession();
      }
    }

    modeSimpleBtn.addEventListener('click', () => switchMode('simple'));
    modeBatchBtn.addEventListener('click', () => switchMode('batch'));

    // Check URL for mode on load
    function checkUrlMode() {
      const params = new URLSearchParams(window.location.search);
      if (params.get('mode') === 'batch') {
        switchMode('batch');
      }
    }

    // ============================
    // SIMPLE MODE FUNCTIONS
    // ============================
    function validateInputs() {
      const isValid = dnInput.value && fluidTypeInput.value &&
                      orificeInput.value && pressureInput.value > 0;
      calculateBtn.disabled = !isValid;
      return isValid;
    }

    [dnInput, fluidTypeInput, orificeInput, pressureInput].forEach(input => {
      input.addEventListener('input', validateInputs);
    });

    function calculateForce() {
      if (!validateInputs()) return;

      calculateBtn.classList.add('btn-loading');
      calculateBtn.disabled = true;

      setTimeout(() => {
        const dn = dnInput.value;
        const fluidType = fluidTypeInput.value;
        const orifice = orificeInput.value;
        const pressure = parseFloat(pressureInput.value);

        const kf = kfTable[dn][fluidType];
        const area = areaTable[orifice];
        const force = kf * area * pressure;

        forceValue.textContent = force.toFixed(2);

        paramsSummary.innerHTML = `
          <strong>DN:</strong> ${dn}<br>
          <strong>Fluide:</strong> ${fluidType === 'gaz' ? 'Gaz' : 'Vapeur d\'eau'}<br>
          <strong>Orifice:</strong> ${orifice} (${area} cm2)<br>
          <strong>Kf:</strong> ${kf}<br>
          <strong>P1:</strong> ${pressure.toFixed(2)} bar abs
        `;

        resultsSection.classList.add('show');

        // V2.0 - Update design force and components
        updateDesignForce();

        if (window.innerWidth < 1024) {
          setTimeout(() => {
            resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
          }, 100);
        }

        calculateBtn.classList.remove('btn-loading');
        calculateBtn.disabled = false;
      }, 300);
    }

    function resetForm() {
      dnInput.value = '';
      fluidTypeInput.value = '';
      orificeInput.value = '';
      pressureInput.value = '';
      resultsSection.classList.remove('show');

      // V2.0 - Reset P1 calculator
      p1CalcPanel.classList.remove('show');
      p1CalcToggle.classList.remove('open');
      p1CalcResult.classList.remove('show');
      p1Ptarage.value = '';
      p1Surpression.value = '10';
      p1Patm.value = '1.013';

      // V2.0 - Reset config panel
      fDesignValue.textContent = '-';
      fxValue.textContent = '-';
      fyValue.textContent = '-';
      fzValue.textContent = '-';
      forceDiagram.innerHTML = '';

      validateInputs();
    }

    function copyResult() {
      const fBrute = forceValue.textContent;
      const fDesign = fDesignValue.textContent;
      const fx = fxValue.textContent;
      const fy = fyValue.textContent;
      const fz = fzValue.textContent;
      const dlf = getCurrentDLF();
      const config = configurationsTable[appState.selectedConfig];

      let text = `Force brute: ${fBrute} daN\n`;
      text += `DLF: ${dlf}\n`;
      text += `Force de design: ${fDesign} daN\n`;
      text += `Configuration: ${config.label}\n`;
      text += `Fx: ${fx} daN | Fy: ${fy} daN | Fz: ${fz} daN`;

      navigator.clipboard.writeText(text).then(() => {
        showToast('Resultat copie dans le presse-papier');
      });
    }

    function printResult() {
      window.print();
    }

    calculateBtn.addEventListener('click', calculateForce);
    resetBtn.addEventListener('click', resetForm);
    copyBtn.addEventListener('click', copyResult);
    printBtn.addEventListener('click', printResult);

    pressureInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !calculateBtn.disabled) {
        calculateForce();
      }
    });

    // ============================
    // V2.0 - P1 CALCULATOR
    // ============================
    p1CalcToggle.addEventListener('click', () => {
      const isOpen = p1CalcPanel.classList.toggle('show');
      p1CalcToggle.classList.toggle('open', isOpen);
    });

    p1CalcApplyBtn.addEventListener('click', () => {
      const ptarage = parseFloat(p1Ptarage.value);
      const surpression = parseFloat(p1Surpression.value);
      const patm = parseFloat(p1Patm.value);

      if (isNaN(ptarage) || ptarage <= 0) {
        showToast('P_tarage doit etre superieur a 0', 'error');
        return;
      }
      if (isNaN(surpression) || surpression < 0 || surpression > 100) {
        showToast('Surpression doit etre entre 0% et 100%', 'error');
        return;
      }
      if (isNaN(patm) || patm < 0.8 || patm > 1.1) {
        showToast('P_atm doit etre entre 0.8 et 1.1 bar', 'error');
        return;
      }

      const p1 = ptarage * (1 + surpression / 100) + patm;
      pressureInput.value = p1.toFixed(2);

      p1CalcResult.innerHTML = `<strong>P1 = ${ptarage} x (1 + ${surpression}/100) + ${patm} = ${p1.toFixed(2)} bar abs</strong>`;
      p1CalcResult.classList.add('show');

      validateInputs();
      showToast('P1 calcule et reporte : ' + p1.toFixed(2) + ' bar abs');
    });

    // ============================
    // V2.0 - LOAD EXAMPLE
    // ============================
    loadExampleBtn.addEventListener('click', () => {
      dnInput.value = '100';
      fluidTypeInput.value = 'gaz';
      orificeInput.value = 'K';
      pressureInput.value = '15.5';
      validateInputs();
      calculateForce();
      showToast('Exemple charge : DN 100 / Gaz / Orifice K / 15.5 bar abs');
    });

    // ============================
    // V2.0 - CONFIGURATION PANEL
    // ============================
    configPanelHeader.addEventListener('click', () => {
      const isOpen = configPanelBody.classList.toggle('show');
      configPanelToggle.classList.toggle('open', isOpen);
    });

    // Discharge configuration selection
    configOptions.addEventListener('click', (e) => {
      const option = e.target.closest('.config-option');
      if (!option) return;

      configOptions.querySelectorAll('.config-option').forEach(o => o.classList.remove('active'));
      option.classList.add('active');
      option.querySelector('input[type="radio"]').checked = true;

      appState.selectedConfig = option.dataset.config;
      updateDesignForce();
    });

    // DLF mode selection
    dlfOptions.addEventListener('click', (e) => {
      const option = e.target.closest('.dlf-option');
      if (!option) return;

      dlfOptions.querySelectorAll('.dlf-option').forEach(o => o.classList.remove('active'));
      option.classList.add('active');
      option.querySelector('input[type="radio"]').checked = true;

      const mode = option.dataset.dlf;
      appState.dlfMode = mode;

      if (mode === 'custom') {
        dlfCustomInput.classList.add('show');
        const val = parseFloat(dlfCustomValue.value);
        appState.dlfValue = isNaN(val) ? 2.0 : val;
      } else {
        dlfCustomInput.classList.remove('show');
        appState.dlfValue = dlfPresets[mode].value;
      }

      validateDLF(appState.dlfValue);
      updateDesignForce();
    });

    dlfCustomValue.addEventListener('input', () => {
      const val = parseFloat(dlfCustomValue.value);
      if (!isNaN(val)) {
        appState.dlfValue = val;
        validateDLF(val);
        updateDesignForce();
      }
    });

    function validateDLF(value) {
      dlfWarning.classList.remove('show', 'warning-low', 'warning-high');

      if (value < 1.0) {
        dlfWarning.textContent = 'Valeur inhabituelle  a justifier';
        dlfWarning.classList.add('show', 'warning-low');
      } else if (value > 3.0) {
        dlfWarning.textContent = 'Valeur tres elevee  verifier';
        dlfWarning.classList.add('show', 'warning-high');
      }
    }

    function getCurrentDLF() {
      if (appState.dlfMode === 'custom') {
        const val = parseFloat(dlfCustomValue.value);
        return isNaN(val) ? 2.0 : Math.max(0.5, Math.min(5.0, val));
      }
      return dlfPresets[appState.dlfMode].value;
    }

    function updateDesignForce() {
      const forceText = forceValue.textContent;
      if (forceText === '-') return;

      const fBrute = parseFloat(forceText);
      if (isNaN(fBrute)) return;

      const dlf = getCurrentDLF();
      const fDesign = fBrute * dlf;

      const config = configurationsTable[appState.selectedConfig];
      const components = config.components(parseFloat(fDesign.toFixed(2)));

      fDesignValue.textContent = fDesign.toFixed(2);
      fxValue.textContent = components.fx.toFixed(2);
      fyValue.textContent = components.fy.toFixed(2);
      fzValue.textContent = components.fz.toFixed(2);

      updateForceDiagram(appState.selectedConfig, fDesign);
    }

    function updateForceDiagram(configId, fDesign) {
      const diagrams = {
        'CFG-1': `<svg viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
          <text x="100" y="12" text-anchor="middle" font-size="10" font-weight="600" fill="#374151">CFG-1 : Decharge verticale haut</text>
          <rect x="80" y="70" width="40" height="50" rx="3" fill="#E5E7EB" stroke="#6B7280" stroke-width="2"/>
          <rect x="85" y="55" width="30" height="20" rx="2" fill="#D1D5DB" stroke="#6B7280" stroke-width="2"/>
          <line x1="100" y1="55" x2="100" y2="25" stroke="#3B82F6" stroke-width="2.5" marker-end="url(#dArrowB)"/>
          <line x1="100" y1="120" x2="100" y2="148" stroke="#EF4444" stroke-width="3" marker-end="url(#dArrowR)"/>
          <text x="115" y="40" font-size="9" fill="#3B82F6">Sortie</text>
          <text x="115" y="140" font-size="9" font-weight="600" fill="#EF4444">Fy = -${fDesign.toFixed(0)} daN</text>
          <text x="10" y="148" font-size="8" fill="#6B7280">Fx=0, Fz=0</text>
          <defs><marker id="dArrowB" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#3B82F6"/></marker>
          <marker id="dArrowR" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#EF4444"/></marker></defs>
        </svg>`,
        'CFG-2': `<svg viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
          <text x="100" y="12" text-anchor="middle" font-size="10" font-weight="600" fill="#374151">CFG-2 : Decharge verticale bas</text>
          <rect x="80" y="40" width="40" height="50" rx="3" fill="#E5E7EB" stroke="#6B7280" stroke-width="2"/>
          <rect x="85" y="85" width="30" height="20" rx="2" fill="#D1D5DB" stroke="#6B7280" stroke-width="2"/>
          <line x1="100" y1="105" x2="100" y2="135" stroke="#3B82F6" stroke-width="2.5" marker-end="url(#dArrowB2)"/>
          <line x1="100" y1="40" x2="100" y2="20" stroke="#EF4444" stroke-width="3" marker-end="url(#dArrowR2)"/>
          <text x="115" y="130" font-size="9" fill="#3B82F6">Sortie</text>
          <text x="115" y="30" font-size="9" font-weight="600" fill="#EF4444">Fy = +${fDesign.toFixed(0)} daN</text>
          <text x="10" y="148" font-size="8" fill="#6B7280">Fx=0, Fz=0</text>
          <defs><marker id="dArrowB2" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#3B82F6"/></marker>
          <marker id="dArrowR2" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#EF4444"/></marker></defs>
        </svg>`,
        'CFG-3': `<svg viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
          <text x="100" y="12" text-anchor="middle" font-size="10" font-weight="600" fill="#374151">CFG-3 : Decharge horizontale</text>
          <rect x="40" y="55" width="50" height="40" rx="3" fill="#E5E7EB" stroke="#6B7280" stroke-width="2"/>
          <rect x="85" y="62" width="20" height="26" rx="2" fill="#D1D5DB" stroke="#6B7280" stroke-width="2"/>
          <line x1="105" y1="75" x2="155" y2="75" stroke="#3B82F6" stroke-width="2.5" marker-end="url(#dArrowB3)"/>
          <line x1="40" y1="75" x2="10" y2="75" stroke="#EF4444" stroke-width="3" marker-end="url(#dArrowR3)"/>
          <text x="140" y="68" font-size="9" fill="#3B82F6">Sortie</text>
          <text x="10" y="100" font-size="9" font-weight="600" fill="#EF4444">Fx = -${fDesign.toFixed(0)} daN</text>
          <text x="10" y="148" font-size="8" fill="#6B7280">Fy=0, Fz=0</text>
          <defs><marker id="dArrowB3" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#3B82F6"/></marker>
          <marker id="dArrowR3" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#EF4444"/></marker></defs>
        </svg>`,
        'CFG-4': `<svg viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
          <text x="100" y="12" text-anchor="middle" font-size="10" font-weight="600" fill="#374151">CFG-4 : Coude 90</text>
          <rect x="55" y="75" width="40" height="40" rx="3" fill="#E5E7EB" stroke="#6B7280" stroke-width="2"/>
          <path d="M75 75 L75 50 Q75 40 85 40 L110 40" stroke="#D1D5DB" stroke-width="8" fill="none"/>
          <path d="M75 75 L75 50 Q75 40 85 40 L110 40" stroke="#6B7280" stroke-width="2" fill="none"/>
          <line x1="110" y1="40" x2="155" y2="40" stroke="#3B82F6" stroke-width="2.5" marker-end="url(#dArrowB4)"/>
          <line x1="75" y1="115" x2="75" y2="145" stroke="#EF4444" stroke-width="2.5" marker-end="url(#dArrowR4a)"/>
          <line x1="55" y1="95" x2="20" y2="95" stroke="#EF4444" stroke-width="2.5" marker-end="url(#dArrowR4b)"/>
          <text x="145" y="35" font-size="9" fill="#3B82F6">Sortie</text>
          <text x="85" y="140" font-size="8" font-weight="600" fill="#EF4444">Fy = -${(fDesign/Math.sqrt(2)).toFixed(0)}</text>
          <text x="5" y="108" font-size="8" font-weight="600" fill="#EF4444">Fx = -${(fDesign/Math.sqrt(2)).toFixed(0)}</text>
          <text x="10" y="148" font-size="8" fill="#6B7280">Fz=0</text>
          <defs><marker id="dArrowB4" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#3B82F6"/></marker>
          <marker id="dArrowR4a" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#EF4444"/></marker>
          <marker id="dArrowR4b" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#EF4444"/></marker></defs>
        </svg>`,
        'CFG-5': `<svg viewBox="0 0 200 160" fill="none" xmlns="http://www.w3.org/2000/svg">
          <text x="100" y="12" text-anchor="middle" font-size="10" font-weight="600" fill="#374151">CFG-5 : Collecteur (torche)</text>
          <rect x="30" y="55" width="40" height="40" rx="3" fill="#E5E7EB" stroke="#6B7280" stroke-width="2"/>
          <rect x="65" y="62" width="15" height="26" rx="2" fill="#D1D5DB" stroke="#6B7280" stroke-width="2"/>
          <rect x="80" y="40" width="80" height="70" rx="5" fill="#F9FAFB" stroke="#6B7280" stroke-width="1.5" stroke-dasharray="4 3"/>
          <text x="120" y="78" text-anchor="middle" font-size="9" fill="#6B7280">Collecteur</text>
          <line x1="30" y1="75" x2="8" y2="75" stroke="#EF4444" stroke-width="3" marker-end="url(#dArrowR5)"/>
          <text x="10" y="100" font-size="9" font-weight="600" fill="#EF4444">Fx = -${fDesign.toFixed(0)} daN</text>
          <text x="10" y="148" font-size="8" fill="#6B7280">Fy=0, Fz=0 (contre-pression reduit F)</text>
          <defs><marker id="dArrowR5" markerWidth="8" markerHeight="8" refX="6" refY="4" orient="auto"><path d="M0,0 L8,4 L0,8 Z" fill="#EF4444"/></marker></defs>
        </svg>`
      };

      forceDiagram.innerHTML = diagrams[configId] || '';
    }

    // ============================
    // BATCH MODE - INPUT METHOD
    // ============================
    function switchInputMethod(method) {
      appState.batchInputMethod = method;

      methodFormOption.classList.toggle('active', method === 'form');
      methodCsvOption.classList.toggle('active', method === 'csv');

      batchFormContainer.style.display = method === 'form' ? 'block' : 'none';
      csvImportZone.classList.toggle('show', method === 'csv');
    }

    methodFormOption.addEventListener('click', () => switchInputMethod('form'));
    methodCsvOption.addEventListener('click', () => switchInputMethod('csv'));

    // ============================
    // BATCH MODE - FORM HANDLING
    // ============================
    function createEmptyPSV() {
      return {
        itemId: '',
        lineName: '',
        dn: '',
        fluidType: '',
        orifice: '',
        pressure: '',
        config: 'CFG-1',
        dlf: 2.0,
        status: 'empty',
        errors: {}
      };
    }

    function generateDNOptions(selected = '') {
      return `
        <option value="">--</option>
        ${validDNs.map(dn => `<option value="${dn}" ${selected === dn ? 'selected' : ''}>${dn}</option>`).join('')}
      `;
    }

    function generateFluidOptions(selected = '') {
      return `
        <option value="">--</option>
        <option value="gaz" ${selected === 'gaz' ? 'selected' : ''}>Gaz</option>
        <option value="vapeur eau" ${selected === 'vapeur eau' ? 'selected' : ''}>Vapeur</option>
      `;
    }

    function generateOrificeOptions(selected = '') {
      return `
        <option value="">--</option>
        ${validOrifices.map(o => `<option value="${o}" ${selected === o ? 'selected' : ''}>${o}</option>`).join('')}
      `;
    }

    function generateConfigOptions(selected = 'CFG-1') {
      return validConfigs.map(c =>
        `<option value="${c}" ${selected === c ? 'selected' : ''}>${configurationsTable[c].label}</option>`
      ).join('');
    }

    function renderBatchRow(psv, index) {
      const row = document.createElement('tr');
      row.dataset.index = index;
      row.innerHTML = `
        <td class="row-number">${index + 1}</td>
        <td class="input-cell">
          <input type="text"
                 class="batch-input"
                 data-field="itemId"
                 value="${psv.itemId || ''}"
                 placeholder="PSV-001"
                 maxlength="50">
          <div class="field-error" data-error="itemId"></div>
        </td>
        <td class="input-cell">
          <input type="text"
                 class="batch-input"
                 data-field="lineName"
                 value="${psv.lineName || ''}"
                 placeholder="Ligne vapeur HP"
                 maxlength="100">
          <div class="field-error" data-error="lineName"></div>
        </td>
        <td class="select-cell">
          <select class="batch-input" data-field="dn">
            ${generateDNOptions(psv.dn)}
          </select>
          <div class="field-error" data-error="dn"></div>
        </td>
        <td class="select-cell">
          <select class="batch-input" data-field="fluidType">
            ${generateFluidOptions(psv.fluidType)}
          </select>
          <div class="field-error" data-error="fluidType"></div>
        </td>
        <td class="select-cell">
          <select class="batch-input" data-field="orifice">
            ${generateOrificeOptions(psv.orifice)}
          </select>
          <div class="field-error" data-error="orifice"></div>
        </td>
        <td class="input-cell">
          <input type="number"
                 class="batch-input"
                 data-field="pressure"
                 value="${psv.pressure || ''}"
                 placeholder="ex: 15.5"
                 min="0"
                 max="999.99"
                 step="0.01">
          <div class="field-error" data-error="pressure"></div>
        </td>
        <td class="select-cell">
          <select class="batch-input" data-field="config">
            ${generateConfigOptions(psv.config || 'CFG-1')}
          </select>
        </td>
        <td class="input-cell">
          <input type="number"
                 class="batch-input"
                 data-field="dlf"
                 value="${psv.dlf || 2.0}"
                 placeholder="2.0"
                 min="0.5"
                 max="5.0"
                 step="0.1"
                 style="width:70px">
        </td>
        <td class="action-cell">
          <button class="delete-row-btn" title="Supprimer cette ligne">&#10005;</button>
        </td>
      `;
      return row;
    }

    function renderMobileCard(psv, index) {
      const card = document.createElement('div');
      card.className = 'batch-input-card';
      card.dataset.index = index;
      card.innerHTML = `
        <div class="batch-input-card-header">
          <span class="batch-input-card-number">PSV #${index + 1}</span>
          <button class="batch-input-card-delete delete-row-btn-mobile" title="Supprimer">&#10005;</button>
        </div>
        <div class="batch-input-card-fields">
          <div class="batch-input-card-row">
            <div class="batch-input-card-field">
              <label>ITEM ID</label>
              <input type="text" class="batch-input-mobile" data-field="itemId" value="${psv.itemId || ''}" placeholder="PSV-001" maxlength="50">
            </div>
            <div class="batch-input-card-field">
              <label>DN</label>
              <select class="batch-input-mobile" data-field="dn">${generateDNOptions(psv.dn)}</select>
            </div>
          </div>
          <div class="batch-input-card-field full-width">
            <label>Nom de ligne</label>
            <input type="text" class="batch-input-mobile" data-field="lineName" value="${psv.lineName || ''}" placeholder="Ligne vapeur HP" maxlength="100">
          </div>
          <div class="batch-input-card-row">
            <div class="batch-input-card-field">
              <label>Fluide</label>
              <select class="batch-input-mobile" data-field="fluidType">${generateFluidOptions(psv.fluidType)}</select>
            </div>
            <div class="batch-input-card-field">
              <label>Orifice</label>
              <select class="batch-input-mobile" data-field="orifice">${generateOrificeOptions(psv.orifice)}</select>
            </div>
          </div>
          <div class="batch-input-card-field full-width">
            <label>Pression (bar abs)</label>
            <input type="number" class="batch-input-mobile" data-field="pressure" value="${psv.pressure || ''}" placeholder="ex: 15.5" min="0" max="999.99" step="0.01">
          </div>
          <div class="batch-input-card-row">
            <div class="batch-input-card-field">
              <label>Config.</label>
              <select class="batch-input-mobile" data-field="config">${generateConfigOptions(psv.config || 'CFG-1')}</select>
            </div>
            <div class="batch-input-card-field">
              <label>DLF</label>
              <input type="number" class="batch-input-mobile" data-field="dlf" value="${psv.dlf || 2.0}" placeholder="2.0" min="0.5" max="5.0" step="0.1">
            </div>
          </div>
        </div>
      `;
      return card;
    }

    function renderBatchTable() {
      // Render desktop table
      batchTableBody.innerHTML = '';
      appState.psvList.forEach((psv, index) => {
        batchTableBody.appendChild(renderBatchRow(psv, index));
      });

      // Render mobile cards
      batchInputCards.innerHTML = '';
      appState.psvList.forEach((psv, index) => {
        batchInputCards.appendChild(renderMobileCard(psv, index));
      });

      attachBatchEventListeners();
      validateBatchForm();
    }

    function attachBatchEventListeners() {
      // Desktop table input events
      document.querySelectorAll('.batch-input').forEach(input => {
        input.addEventListener('input', debounce((e) => {
          const row = e.target.closest('tr');
          const index = parseInt(row.dataset.index);
          const field = e.target.dataset.field;
          let value = e.target.value;

          if ((field === 'pressure' || field === 'dlf') && value) {
            value = parseFloat(value);
          }

          appState.psvList[index][field] = value;
          validateRow(index);
          validateBatchForm();
          saveToLocalStorage();
        }, 300));

        input.addEventListener('blur', (e) => {
          e.target.classList.add('touched');
          const row = e.target.closest('tr');
          const index = parseInt(row.dataset.index);
          validateRow(index);
        });
      });

      // Delete row buttons (desktop)
      document.querySelectorAll('.delete-row-btn').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const row = e.target.closest('tr');
          const index = parseInt(row.dataset.index);
          deleteRow(index);
        });
      });

      // Mobile card input events
      document.querySelectorAll('.batch-input-mobile').forEach(input => {
        input.addEventListener('input', debounce((e) => {
          const card = e.target.closest('.batch-input-card');
          const index = parseInt(card.dataset.index);
          const field = e.target.dataset.field;
          let value = e.target.value;

          if ((field === 'pressure' || field === 'dlf') && value) {
            value = parseFloat(value);
          }

          appState.psvList[index][field] = value;
          validateRow(index);
          validateBatchForm();
          saveToLocalStorage();
        }, 300));

        input.addEventListener('blur', (e) => {
          e.target.classList.add('touched');
        });
      });

      // Delete row buttons (mobile)
      document.querySelectorAll('.delete-row-btn-mobile').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const card = e.target.closest('.batch-input-card');
          const index = parseInt(card.dataset.index);
          deleteRow(index);
        });
      });
    }

    function addRow() {
      appState.psvList.push(createEmptyPSV());
      renderBatchTable();

      // Focus on the new row's first input
      const lastRow = batchTableBody.lastElementChild;
      if (lastRow) {
        const firstInput = lastRow.querySelector('input[data-field="itemId"]');
        if (firstInput) firstInput.focus();
      }
    }

    function addFiveRows() {
      for (let i = 0; i < 5; i++) {
        appState.psvList.push(createEmptyPSV());
      }
      renderBatchTable();
    }

    function deleteRow(index) {
      const psv = appState.psvList[index];
      const hasData = psv.itemId || psv.lineName || psv.dn || psv.fluidType || psv.orifice || psv.pressure;

      if (hasData) {
        if (!confirm('Supprimer cette ligne ?')) {
          return;
        }
      }

      // Keep at least one row
      if (appState.psvList.length <= 1) {
        appState.psvList = [createEmptyPSV()];
      } else {
        appState.psvList.splice(index, 1);
      }

      renderBatchTable();
      saveToLocalStorage();
    }

    function initBatchForm() {
      // Initialize with 5 empty rows
      appState.psvList = [];
      for (let i = 0; i < 5; i++) {
        appState.psvList.push(createEmptyPSV());
      }
      renderBatchTable();
    }

    addRowBtn.addEventListener('click', addRow);
    addFiveRowsBtn.addEventListener('click', addFiveRows);

    // ============================
    // BATCH MODE - VALIDATION
    // ============================
    function validatePSV(psv, index) {
      const errors = {};

      // Check if row is empty
      const isEmpty = !psv.itemId && !psv.lineName && !psv.dn &&
                      !psv.fluidType && !psv.orifice && !psv.pressure;
      if (isEmpty) {
        return { isValid: false, isEmpty: true, errors };
      }

      // ITEM ID
      if (!psv.itemId || psv.itemId.trim() === '') {
        errors.itemId = 'Requis';
      } else if (psv.itemId.length > 50) {
        errors.itemId = 'Max 50 caracteres';
      } else {
        // Check for duplicates
        const duplicate = appState.psvList.findIndex((p, i) =>
          i !== index && p.itemId && p.itemId.toLowerCase() === psv.itemId.toLowerCase()
        );
        if (duplicate !== -1) {
          errors.itemId = `Doublon (ligne ${duplicate + 1})`;
        }
      }

      // Line Name
      if (!psv.lineName || psv.lineName.trim() === '') {
        errors.lineName = 'Requis';
      } else if (psv.lineName.length > 100) {
        errors.lineName = 'Max 100 caracteres';
      }

      // DN
      if (!psv.dn) {
        errors.dn = 'Requis';
      } else if (!validDNs.includes(psv.dn)) {
        errors.dn = 'Invalide';
      }

      // Fluid Type
      if (!psv.fluidType) {
        errors.fluidType = 'Requis';
      } else if (!validFluids.includes(psv.fluidType)) {
        errors.fluidType = 'Invalide';
      }

      // Orifice
      if (!psv.orifice) {
        errors.orifice = 'Requis';
      } else if (!validOrifices.includes(psv.orifice)) {
        errors.orifice = 'Invalide';
      }

      // Pressure
      const pressure = parseFloat(psv.pressure);
      if (!psv.pressure && psv.pressure !== 0) {
        errors.pressure = 'Requis';
      } else if (isNaN(pressure) || pressure <= 0) {
        errors.pressure = 'Doit etre > 0';
      } else if (pressure > 999.99) {
        errors.pressure = 'Max 999.99';
      }

      return {
        isValid: Object.keys(errors).length === 0,
        isEmpty: false,
        errors
      };
    }

    function validateRow(index) {
      const psv = appState.psvList[index];
      const validation = validatePSV(psv, index);
      psv.errors = validation.errors;
      psv.status = validation.isEmpty ? 'empty' : (validation.isValid ? 'valid' : 'error');

      // Update UI
      const row = batchTableBody.querySelector(`tr[data-index="${index}"]`);
      if (row) {
        // Clear previous states
        row.querySelectorAll('.batch-input').forEach(input => {
          input.classList.remove('valid', 'invalid');
        });
        row.querySelectorAll('.field-error').forEach(el => {
          el.textContent = '';
        });

        // Apply new states
        Object.entries(psv.errors).forEach(([field, message]) => {
          const input = row.querySelector(`[data-field="${field}"]`);
          const errorEl = row.querySelector(`[data-error="${field}"]`);
          if (input) input.classList.add('invalid');
          if (errorEl) errorEl.textContent = message;
        });

        // Mark valid fields
        if (!validation.isEmpty) {
          ['itemId', 'lineName', 'dn', 'fluidType', 'orifice', 'pressure'].forEach(field => {
            if (!psv.errors[field] && psv[field]) {
              const input = row.querySelector(`[data-field="${field}"]`);
              if (input && input.classList.contains('touched')) {
                input.classList.add('valid');
              }
            }
          });
        }
      }

      return validation;
    }

    function validateBatchForm() {
      let validCount = 0;
      let errorCount = 0;
      let emptyCount = 0;

      appState.psvList.forEach((psv, index) => {
        const validation = validatePSV(psv, index);
        if (validation.isEmpty) {
          emptyCount++;
        } else if (validation.isValid) {
          validCount++;
        } else {
          errorCount++;
        }
      });

      appState.stats = {
        total: appState.psvList.length,
        valid: validCount,
        errors: errorCount,
        empty: emptyCount
      };

      // Enable/disable calculate button
      calculateBatchBtn.disabled = validCount === 0;

      return appState.stats;
    }

    // ============================
    // BATCH MODE - CALCULATION
    // ============================
    function calculatePSVForce(psv, index) {
      const validation = validatePSV(psv, index);

      if (validation.isEmpty) {
        return { ...psv, status: 'empty' };
      }

      if (!validation.isValid) {
        return {
          ...psv,
          status: 'error',
          errors: validation.errors,
          errorMessage: Object.values(validation.errors)[0]
        };
      }

      const kf = kfTable[psv.dn][psv.fluidType];
      const area = areaTable[psv.orifice];
      const pressure = parseFloat(psv.pressure);
      const force = kf * area * pressure;

      // V2.0 - DLF and directional components
      const dlf = parseFloat(psv.dlf) || 2.0;
      const configId = psv.config || 'CFG-1';
      const fDesign = parseFloat((force * dlf).toFixed(2));
      const config = configurationsTable[configId];
      const components = config ? config.components(fDesign) : { fx: 0, fy: -fDesign, fz: 0 };

      return {
        ...psv,
        kf,
        area,
        force: parseFloat(force.toFixed(2)),
        dlf,
        config: configId,
        fDesign,
        fx: components.fx,
        fy: components.fy,
        fz: components.fz,
        status: 'calculated',
        errors: {}
      };
    }

    function calculateBatch() {
      showLoading('Calcul en cours...');

      setTimeout(() => {
        appState.results = [];
        let validCount = 0;
        let errorCount = 0;

        appState.psvList.forEach((psv, index) => {
          const result = calculatePSVForce(psv, index);
          if (result.status !== 'empty') {
            appState.results.push(result);
            if (result.status === 'calculated') {
              validCount++;
            } else {
              errorCount++;
            }
          }
        });

        appState.calculated = true;
        appState.stats.valid = validCount;
        appState.stats.errors = errorCount;

        renderResults();
        hideLoading();

        // Show results section
        batchResults.classList.add('show');

        // Scroll to results
        setTimeout(() => {
          batchResults.scrollIntoView({ behavior: 'smooth', block: 'start' });
        }, 100);

        showToast(`Calcul termine : ${validCount} valides, ${errorCount} erreurs`);
      }, 300);
    }

    calculateBatchBtn.addEventListener('click', calculateBatch);

    // ============================
    // BATCH MODE - RESULTS DISPLAY
    // ============================
    function renderResults() {
      // Update stats
      document.getElementById('resultsValidCount').textContent = `${appState.stats.valid} valides`;
      document.getElementById('resultsErrorCount').textContent = `${appState.stats.errors} erreurs`;

      // Render table (desktop)
      resultsTableBody.innerHTML = '';
      appState.results.forEach(result => {
        const row = document.createElement('tr');
        if (result.status === 'error') {
          row.classList.add('row-error');
        }

        row.innerHTML = `
          <td class="text-left">${result.itemId || '-'}</td>
          <td class="text-left">${result.lineName || '-'}</td>
          <td>${result.dn || '-'}</td>
          <td>${result.fluidType === 'vapeur eau' ? 'Vapeur' : (result.fluidType || '-')}</td>
          <td>${result.orifice || '-'}</td>
          <td class="text-right">${result.pressure ? parseFloat(result.pressure).toFixed(2) : '-'}</td>
          <td class="text-right">${result.kf || '-'}</td>
          <td class="text-right">${result.area || '-'}</td>
          <td class="text-right">${result.force ? result.force.toFixed(2) : '-'}</td>
          <td class="text-right">${result.dlf || '-'}</td>
          <td class="force-cell text-right">${result.fDesign ? result.fDesign.toFixed(2) : '-'}</td>
          <td class="text-right">${result.fx !== undefined ? result.fx.toFixed(2) : '-'}</td>
          <td class="text-right">${result.fy !== undefined ? result.fy.toFixed(2) : '-'}</td>
          <td class="text-right">${result.fz !== undefined ? result.fz.toFixed(2) : '-'}</td>
          <td>
            ${result.status === 'calculated'
              ? '<span class="badge badge-success">Valide</span>'
              : `<span class="badge badge-error">${result.errorMessage || 'Erreur'}</span>`}
          </td>
        `;
        resultsTableBody.appendChild(row);
      });

      // Render cards (mobile)
      resultsCards.innerHTML = '';
      appState.results.forEach(result => {
        const card = document.createElement('div');
        card.className = `result-card-mobile ${result.status === 'error' ? 'error' : ''}`;

        card.innerHTML = `
          <div class="result-card-mobile-header">
            <div>
              <div class="result-card-mobile-id">${result.itemId || '-'}</div>
              <div class="result-card-mobile-line">${result.lineName || '-'}</div>
            </div>
            ${result.status === 'calculated'
              ? '<span class="badge badge-success">Valide</span>'
              : `<span class="badge badge-error">${result.errorMessage || 'Erreur'}</span>`}
          </div>
          <div class="result-card-mobile-force">
            ${result.fDesign ? 'F_design: ' + result.fDesign.toFixed(2) + ' daN' : (result.force ? result.force.toFixed(2) + ' daN' : '-')}
          </div>
          <div class="result-card-mobile-params">
            <div><strong>DN:</strong> ${result.dn || '-'}</div>
            <div><strong>Fluide:</strong> ${result.fluidType === 'vapeur eau' ? 'Vapeur' : (result.fluidType || '-')}</div>
            <div><strong>Orifice:</strong> ${result.orifice || '-'}</div>
            <div><strong>P1:</strong> ${result.pressure ? parseFloat(result.pressure).toFixed(2) + ' bar' : '-'}</div>
            <div><strong>F brute:</strong> ${result.force ? result.force.toFixed(2) + ' daN' : '-'}</div>
            <div><strong>DLF:</strong> ${result.dlf || '-'}</div>
            <div><strong>Fx:</strong> ${result.fx !== undefined ? result.fx.toFixed(2) : '-'}</div>
            <div><strong>Fy:</strong> ${result.fy !== undefined ? result.fy.toFixed(2) : '-'}</div>
            <div><strong>Fz:</strong> ${result.fz !== undefined ? result.fz.toFixed(2) : '-'}</div>
          </div>
        `;
        resultsCards.appendChild(card);
      });
    }

    // ============================
    // BATCH MODE - RESET
    // ============================
    function resetBatch() {
      if (confirm('Reinitialiser toutes les donnees ?')) {
        appState.psvList = [];
        appState.results = [];
        appState.calculated = false;
        appState.stats = { total: 0, valid: 0, errors: 0, empty: 0 };

        batchResults.classList.remove('show');
        csvPreview.classList.remove('show');

        initBatchForm();
        clearLocalStorage();

        showToast('Formulaire reinitialise');
      }
    }

    resetBatchBtn.addEventListener('click', resetBatch);

    // ============================
    // CSV IMPORT
    // ============================
    let parsedCSVData = [];

    // Drag and drop
    dropZone.addEventListener('click', () => csvFileInput.click());

    dropZone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropZone.classList.add('drag-over');
    });

    dropZone.addEventListener('dragleave', () => {
      dropZone.classList.remove('drag-over');
    });

    dropZone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropZone.classList.remove('drag-over');
      const file = e.dataTransfer.files[0];
      if (file) handleCSVFile(file);
    });

    csvFileInput.addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) handleCSVFile(file);
    });

    function handleCSVFile(file) {
      // Validate file
      if (!file.name.toLowerCase().endsWith('.csv')) {
        showToast('Veuillez selectionner un fichier CSV', 'error');
        return;
      }

      if (file.size > 5 * 1024 * 1024) {
        showToast('Le fichier est trop volumineux (max 5 MB)', 'error');
        return;
      }

      // Parse CSV
      Papa.parse(file, {
        header: true,
        skipEmptyLines: true,
        encoding: 'UTF-8',
        complete: function(results) {
          processCSVData(results, file.name);
        },
        error: function(error) {
          showToast('Erreur lors de la lecture du fichier: ' + error.message, 'error');
        }
      });
    }

    function normalizeCSVHeaders(row) {
      const normalized = {};
      const headerMap = {
        'item_id': 'itemId',
        'itemid': 'itemId',
        'item id': 'itemId',
        'line_name': 'lineName',
        'linename': 'lineName',
        'line name': 'lineName',
        'nom_ligne': 'lineName',
        'nom de ligne': 'lineName',
        'dn': 'dn',
        'fluid_type': 'fluidType',
        'fluidtype': 'fluidType',
        'fluid type': 'fluidType',
        'fluide': 'fluidType',
        'type_fluide': 'fluidType',
        'orifice': 'orifice',
        'pressure': 'pressure',
        'pression': 'pressure',
        'pressure_bar': 'pressure',
        'p1': 'pressure',
        'config': 'config',
        'configuration': 'config',
        'discharge_config': 'config',
        'dlf': 'dlf',
        'dynamic_load_factor': 'dlf'
      };

      Object.keys(row).forEach(key => {
        const normalizedKey = key.toLowerCase().trim();
        const mappedKey = headerMap[normalizedKey];
        if (mappedKey) {
          normalized[mappedKey] = row[key];
        }
      });

      return normalized;
    }

    function normalizeFluidType(value) {
      if (!value) return '';
      const v = value.toLowerCase().trim();
      if (v === 'gaz' || v === 'gas') return 'gaz';
      if (v === 'vapeur eau' || v === 'vapeur' || v === 'steam' || v === 'vapeur d\'eau') return 'vapeur eau';
      return value;
    }

    function normalizeDN(value) {
      if (!value) return '';
      const v = value.toString().trim();
      if (v === '>200' || v === '> 200' || v === 'more than 200') return '>200';
      return v;
    }

    function normalizeConfig(value) {
      if (!value) return 'CFG-1';
      const v = value.toString().trim().toUpperCase();
      if (v.startsWith('CFG-') && validConfigs.includes(v)) return v;
      // Try numeric mapping
      const num = parseInt(v);
      if (num >= 1 && num <= 5) return 'CFG-' + num;
      return 'CFG-1';
    }

    function processCSVData(results, fileName) {
      parsedCSVData = [];
      const errors = [];
      let validCount = 0;
      let warningCount = 0;
      let errorCount = 0;

      results.data.forEach((row, index) => {
        const lineNum = index + 2; // Account for header row
        const normalized = normalizeCSVHeaders(row);

        // Skip completely empty rows
        const isEmpty = !normalized.itemId && !normalized.lineName &&
                       !normalized.dn && !normalized.fluidType &&
                       !normalized.orifice && !normalized.pressure;
        if (isEmpty) return;

        const psv = {
          itemId: (normalized.itemId || '').trim(),
          lineName: (normalized.lineName || '').trim(),
          dn: normalizeDN(normalized.dn),
          fluidType: normalizeFluidType(normalized.fluidType),
          orifice: (normalized.orifice || '').toUpperCase().trim(),
          pressure: normalized.pressure ? parseFloat(normalized.pressure) : '',
          config: normalizeConfig(normalized.config),
          dlf: normalized.dlf ? parseFloat(normalized.dlf) : 2.0,
          status: 'pending',
          errors: {},
          lineNum
        };

        // Validate
        const rowErrors = [];

        if (!psv.itemId) {
          rowErrors.push('ITEM_ID manquant');
        }
        if (!psv.lineName) {
          rowErrors.push('LINE_NAME manquant');
        }
        if (psv.dn && !validDNs.includes(psv.dn)) {
          rowErrors.push(`DN invalide "${normalized.dn}"`);
        }
        if (psv.fluidType && !validFluids.includes(psv.fluidType)) {
          rowErrors.push(`Fluide invalide "${normalized.fluidType}"`);
        }
        if (psv.orifice && !validOrifices.includes(psv.orifice)) {
          rowErrors.push(`Orifice invalide "${normalized.orifice}"`);
        }
        if (psv.pressure && (isNaN(psv.pressure) || psv.pressure <= 0)) {
          rowErrors.push(`Pression invalide "${normalized.pressure}"`);
        }

        if (rowErrors.length > 0) {
          errorCount++;
          errors.push(`Ligne ${lineNum}: ${rowErrors.join(', ')}`);
          psv.status = 'error';
          psv.errorMessage = rowErrors[0];
        } else if (!psv.dn || !psv.fluidType || !psv.orifice || !psv.pressure) {
          warningCount++;
          psv.status = 'warning';
        } else {
          validCount++;
          psv.status = 'valid';
        }

        parsedCSVData.push(psv);
      });

      // Display preview
      csvFileName.textContent = fileName;
      csvValidCount.textContent = `${validCount} valides`;
      csvWarningCount.textContent = `${warningCount} avertissements`;
      csvErrorCount.textContent = `${errorCount} erreurs`;

      if (errors.length > 0) {
        csvErrorsList.innerHTML = errors.map(e => `<div class="csv-error-item">${e}</div>`).join('');
        csvErrorsList.style.display = 'block';
      } else {
        csvErrorsList.style.display = 'none';
      }

      importCsvBtn.disabled = validCount === 0 && warningCount === 0;
      csvPreview.classList.add('show');
    }

    cancelCsvBtn.addEventListener('click', () => {
      csvPreview.classList.remove('show');
      csvFileInput.value = '';
      parsedCSVData = [];
    });

    importCsvBtn.addEventListener('click', () => {
      // Import valid and warning rows
      const toImport = parsedCSVData.filter(p => p.status === 'valid' || p.status === 'warning');

      if (toImport.length === 0) {
        showToast('Aucune ligne valide a importer', 'error');
        return;
      }

      // Add to psvList
      appState.psvList = toImport.map(p => ({
        itemId: p.itemId,
        lineName: p.lineName,
        dn: p.dn,
        fluidType: p.fluidType,
        orifice: p.orifice,
        pressure: p.pressure,
        config: p.config || 'CFG-1',
        dlf: p.dlf || 2.0,
        status: 'pending',
        errors: {}
      }));

      // Switch to form view and render
      switchInputMethod('form');
      renderBatchTable();

      // Hide preview
      csvPreview.classList.remove('show');
      csvFileInput.value = '';
      parsedCSVData = [];

      saveToLocalStorage();
      showToast(`${toImport.length} lignes importees`);
    });

    // Download template
    downloadTemplateBtn.addEventListener('click', () => {
      const template = `ITEM_ID,LINE_NAME,DN,FLUID_TYPE,ORIFICE,PRESSURE,CONFIG,DLF
PSV-001,Ligne vapeur HP,100,gaz,K,15.5,CFG-1,2.0
PSV-002,Feed H2,150,vapeur eau,M,22.0,CFG-3,2.0
PSV-003,Depart C101,80,gaz,H,18.3,CFG-1,1.0
,,,,,,
,,,,,,
,,,,,,
,,,,,,
,,,,,,
,,,,,,
,,,,,,`;

      const blob = new Blob(['\ufeff' + template], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'template_psv_batch.csv';
      link.click();
      URL.revokeObjectURL(link.href);

      showToast('Template telecharge');
    });

    // ============================
    // EXPORT FUNCTIONS
    // ============================

    // Export CSV
    exportCsvBtn.addEventListener('click', () => {
      if (appState.results.length === 0) {
        showToast('Aucun resultat a exporter', 'error');
        return;
      }

      const headers = ['ITEM_ID', 'LINE_NAME', 'DN', 'FLUID_TYPE', 'ORIFICE', 'PRESSURE_BAR', 'KF', 'AREA_CM2', 'FORCE_DAN', 'CONFIG', 'DLF', 'FORCE_DESIGN_DAN', 'FX_DAN', 'FY_DAN', 'FZ_DAN', 'STATUS', 'ERROR_MESSAGE'];

      const rows = appState.results.map(r => [
        r.itemId || '',
        r.lineName || '',
        r.dn || '',
        r.fluidType || '',
        r.orifice || '',
        r.pressure ? parseFloat(r.pressure).toFixed(2) : '',
        r.kf || '',
        r.area || '',
        r.force ? r.force.toFixed(2) : '',
        r.config || 'CFG-1',
        r.dlf || '',
        r.fDesign ? r.fDesign.toFixed(2) : '',
        r.fx !== undefined ? r.fx.toFixed(2) : '',
        r.fy !== undefined ? r.fy.toFixed(2) : '',
        r.fz !== undefined ? r.fz.toFixed(2) : '',
        r.status === 'calculated' ? 'valid' : 'error',
        r.errorMessage || ''
      ]);

      const csv = [headers, ...rows].map(row => row.join(',')).join('\n');

      const now = new Date();
      const timestamp = now.toISOString().slice(0,10).replace(/-/g,'') + '_' +
                       now.toTimeString().slice(0,8).replace(/:/g,'');

      const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = `psv_batch_results_${timestamp}.csv`;
      link.click();
      URL.revokeObjectURL(link.href);

      showToast('CSV telecharge');
    });

    // Export PDF
    exportPdfBtn.addEventListener('click', () => {
      if (appState.results.length === 0) {
        showToast('Aucun resultat a exporter', 'error');
        return;
      }

      const { jsPDF } = window.jspdf;
      const doc = new jsPDF('l', 'mm', 'a4'); // Landscape

      // Title
      doc.setFontSize(18);
      doc.text('PSV REACTION FORCE - CALCUL BATCH', 14, 20);

      // Date
      doc.setFontSize(10);
      const now = new Date();
      doc.text(`Date : ${now.toLocaleDateString('fr-FR')} ${now.toLocaleTimeString('fr-FR')}`, 14, 28);

      // Summary
      doc.setFontSize(12);
      doc.text(`Resume : ${appState.results.length} PSV | ${appState.stats.valid} valides | ${appState.stats.errors} erreurs`, 14, 38);
      doc.text('Formules : F_brute = Kf x A x P1  |  F_design = F_brute x DLF', 14, 45);

      // Table
      const tableData = appState.results.map(r => [
        r.itemId || '-',
        r.lineName || '-',
        r.dn || '-',
        r.fluidType === 'vapeur eau' ? 'Vapeur' : (r.fluidType || '-'),
        r.orifice || '-',
        r.pressure ? parseFloat(r.pressure).toFixed(2) : '-',
        r.kf || '-',
        r.area || '-',
        r.force ? r.force.toFixed(2) : '-',
        r.dlf || '-',
        r.fDesign ? r.fDesign.toFixed(2) : '-',
        r.fx !== undefined ? r.fx.toFixed(2) : '-',
        r.fy !== undefined ? r.fy.toFixed(2) : '-',
        r.fz !== undefined ? r.fz.toFixed(2) : '-',
        r.status === 'calculated' ? 'Valide' : (r.errorMessage || 'Erreur')
      ]);

      doc.autoTable({
        startY: 52,
        head: [['ITEM ID', 'Ligne', 'DN', 'Fluide', 'Orifice', 'P1', 'Kf', 'A', 'F brute', 'DLF', 'F design', 'Fx', 'Fy', 'Fz', 'Statut']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [79, 124, 255], fontSize: 7 },
        bodyStyles: { fontSize: 7 },
        columnStyles: {
          0: { cellWidth: 20 },
          1: { cellWidth: 25 },
          10: { fontStyle: 'bold' }
        },
        didParseCell: function(data) {
          if (data.section === 'body' && data.column.index === 14) {
            if (data.cell.raw === 'Valide') {
              data.cell.styles.textColor = [5, 150, 105];
            } else {
              data.cell.styles.textColor = [220, 38, 38];
            }
          }
        }
      });

      // Legend
      const finalY = doc.lastAutoTable.finalY + 10;
      doc.setFontSize(9);
      doc.text('Legende :', 14, finalY);
      doc.text('F_brute = Kf x A x P1 | F_design = F_brute x DLF | Fx, Fy, Fz : composantes directionnelles (daN)', 14, finalY + 5);
      doc.text('DLF : Dynamic Load Factor | Toutes les forces en daN | Pressions en bar absolus', 14, finalY + 10);

      // Save
      const timestamp = now.toISOString().slice(0,10).replace(/-/g,'');
      doc.save(`PSV_Batch_Results_${timestamp}.pdf`);

      showToast('PDF telecharge');
    });

    // Copy to clipboard
    copyResultsBtn.addEventListener('click', () => {
      if (appState.results.length === 0) {
        showToast('Aucun resultat a copier', 'error');
        return;
      }

      const headers = ['ITEM_ID', 'LINE_NAME', 'DN', 'FLUID_TYPE', 'ORIFICE', 'P1', 'KF', 'A', 'F_BRUTE', 'DLF', 'F_DESIGN', 'FX', 'FY', 'FZ', 'STATUS'];

      const rows = appState.results.map(r => [
        r.itemId || '',
        r.lineName || '',
        r.dn || '',
        r.fluidType || '',
        r.orifice || '',
        r.pressure ? parseFloat(r.pressure).toFixed(2) : '',
        r.kf || '',
        r.area || '',
        r.force ? r.force.toFixed(2) : '',
        r.dlf || '',
        r.fDesign ? r.fDesign.toFixed(2) : '',
        r.fx !== undefined ? r.fx.toFixed(2) : '',
        r.fy !== undefined ? r.fy.toFixed(2) : '',
        r.fz !== undefined ? r.fz.toFixed(2) : '',
        r.status === 'calculated' ? 'Valide' : 'Erreur'
      ].join('\t'));

      const tsv = [headers.join('\t'), ...rows].join('\n');

      navigator.clipboard.writeText(tsv).then(() => {
        showToast('Copie dans le presse-papier (format tableur)');
      }).catch(() => {
        showToast('Erreur lors de la copie', 'error');
      });
    });

    // ============================
    // LOCAL STORAGE
    // ============================
    function saveToLocalStorage() {
      try {
        localStorage.setItem('psv_calculator_mode', appState.mode);
        localStorage.setItem('psv_calculator_batch_data', JSON.stringify(appState.psvList));
        localStorage.setItem('psv_calculator_batch_timestamp', Date.now().toString());
      } catch (e) {
        console.error('Erreur sauvegarde localStorage:', e);
      }
    }

    function loadFromLocalStorage() {
      try {
        const batchData = localStorage.getItem('psv_calculator_batch_data');
        const timestamp = localStorage.getItem('psv_calculator_batch_timestamp');

        // Restore if session is recent (< 24h)
        if (timestamp && Date.now() - parseInt(timestamp) < 24 * 60 * 60 * 1000) {
          if (batchData) {
            const data = JSON.parse(batchData);
            // Check if there's actual data
            const hasData = data.some(p => p.itemId || p.lineName || p.dn || p.fluidType || p.orifice || p.pressure);
            if (hasData) {
              return data;
            }
          }
        }
        return null;
      } catch (e) {
        console.error('Erreur chargement localStorage:', e);
        return null;
      }
    }

    function clearLocalStorage() {
      localStorage.removeItem('psv_calculator_batch_data');
      localStorage.removeItem('psv_calculator_batch_timestamp');
    }

    function checkSavedSession() {
      const savedData = loadFromLocalStorage();
      if (savedData && savedData.length > 0) {
        sessionRestoreBanner.classList.add('show');
      }
    }

    restoreSessionBtn.addEventListener('click', () => {
      const savedData = loadFromLocalStorage();
      if (savedData) {
        appState.psvList = savedData;
        renderBatchTable();
        showToast('Session restauree');
      }
      sessionRestoreBanner.classList.remove('show');
    });

    discardSessionBtn.addEventListener('click', () => {
      clearLocalStorage();
      sessionRestoreBanner.classList.remove('show');
    });

    // Auto-save every 30 seconds
    setInterval(() => {
      if (appState.mode === 'batch' && appState.psvList.length > 0) {
        const hasData = appState.psvList.some(p => p.itemId || p.lineName || p.dn || p.fluidType || p.orifice || p.pressure);
        if (hasData) {
          saveToLocalStorage();
        }
      }
    }, 30000);

    // ============================
    // INITIALIZATION
    // ============================
    function init() {
      // Check URL mode
      checkUrlMode();

      // Initialize simple mode validation
      validateInputs();

      // Initialize batch form
      initBatchForm();
    }

    // Run on DOM ready
    document.addEventListener('DOMContentLoaded', init);

    // Also run immediately if DOM already loaded
    if (document.readyState !== 'loading') {
      init();
    }
  </script>
</body>
</html>
