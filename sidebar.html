<!DOCTYPE html>
<html>
  <head>
    <base target="_top">
    <style>
      body {
        font-family: Arial, sans-serif;
        padding: 10px;
        background-color: #f5f5f5;
      }
      .form-group {
        margin-bottom: 15px;
      }
      label {
        display: block;
        margin-bottom: 5px;
        font-weight: bold;
      }
      select, input[type="number"] {
        width: 100%;
        padding: 5px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }
      button {
        background-color: #4CAF50;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background-color: #45a049;
      }
      #result {
        margin-top: 20px;
        font-weight: bold;
      }
      #copyButton, #pdfButton {
        display: none;
        margin-top: 10px;
      }
      .loading {
        color: #888;
        font-style: italic;
      }
    </style>
  </head>
  <body>
    <div class="form-group">
      <label for="dn">DN (Diametre Nominal):</label>
      <select id="dn">
        <option value="">Chargement...</option>
      </select>
    </div>
    <div class="form-group">
      <label for="fluidType">Type de fluide:</label>
      <select id="fluidType">
        <option value="">Chargement...</option>
      </select>
    </div>
    <div class="form-group">
      <label for="orifice">Orifice:</label>
      <select id="orifice">
        <option value="">Chargement...</option>
      </select>
    </div>
    <div class="form-group">
      <label for="pressure">Pression de decharge (bars absolus):</label>
      <input type="number" id="pressure" min="0" step="0.1">
    </div>
    <button onclick="calculate()">Calculer</button>
    <div id="result"></div>
    <button id="copyButton" onclick="copyResult()">Copier le resultat</button>
    <button id="pdfButton" onclick="generatePDF()">Exporter en PDF</button>

    <script>
      var forceResult;

      // Charger les options depuis config.gs (source de verite unique)
      google.script.run.withSuccessHandler(function(config) {
        populateSelect('dn', config.validDNs.map(function(dn) {
          return { value: dn, label: dn };
        }));
        populateSelect('fluidType', config.validFluids);
        populateSelect('orifice', config.validOrifices.map(function(o) {
          return { value: o, label: o };
        }));
      }).getConfig();

      function populateSelect(id, options) {
        var select = document.getElementById(id);
        select.innerHTML = '';
        options.forEach(function(opt) {
          var option = document.createElement('option');
          option.value = opt.value;
          option.textContent = opt.label;
          select.appendChild(option);
        });
      }

      function calculate() {
        var dn = document.getElementById('dn').value;
        var fluidType = document.getElementById('fluidType').value;
        var orifice = document.getElementById('orifice').value;
        var pressure = parseFloat(document.getElementById('pressure').value);

        google.script.run.withSuccessHandler(function(result) {
          forceResult = result;
          document.getElementById('result').innerHTML = 'Force de reaction: ' + result + ' daN';
          document.getElementById('copyButton').style.display = 'inline-block';
          document.getElementById('pdfButton').style.display = 'inline-block';
        }).calculateForce(dn, fluidType, orifice, pressure);
      }

      function copyResult() {
        var tempInput = document.createElement("input");
        tempInput.value = forceResult + ' daN';
        document.body.appendChild(tempInput);
        tempInput.select();
        document.execCommand("copy");
        document.body.removeChild(tempInput);
        alert("Resultat copie : " + forceResult + " daN");
      }

      function generatePDF() {
        var dn = document.getElementById('dn').value;
        var fluidType = document.getElementById('fluidType').value;
        var orifice = document.getElementById('orifice').value;
        var pressure = parseFloat(document.getElementById('pressure').value);

        google.script.run.withSuccessHandler(function(pdfUrl) {
          var link = document.createElement('a');
          link.href = pdfUrl;
          link.target = '_blank';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }).generatePDF(dn, fluidType, orifice, pressure, forceResult);
      }
    </script>
  </body>
</html>
